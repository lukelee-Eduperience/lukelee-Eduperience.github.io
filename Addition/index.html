<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åŠ æ³•å°è¶…äºº â€” å­¸ç¿’åŠ æ³•éŠæˆ²ï¼ˆéŸ³æ•ˆé¸é …ï¼‰</title>
  <style>
    :root{
      --bg1:#fff9f2;
      --bg2:#e8f7ff;
      --card:#ffffff;
      --accent:#ff7aa2;
      --accent-2:#6ad3a5;
      --muted:#7b8a9a;
      --wrong:#ff5c5c;
      --child-font: "Comic Sans MS", "Chalkboard SE", "Trebuchet MS", "Segoe UI", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      background: linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      font-family: var(--child-font);
      color:#2b2b2b;
    }
    .wrap{
      width:100%;
      max-width:980px;
      border-radius:18px;
      padding:16px;
      box-shadow: 0 14px 40px rgba(40,60,120,0.08);
      background: linear-gradient(180deg,#fff 0%, #fffefc 100%);
      overflow:hidden;
    }

    header.main{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:10px 6px 0 6px;
    }
    h1{font-size:28px;margin:0;color:var(--accent);letter-spacing:1px;text-shadow:0 2px 0 rgba(255,255,255,0.6)}
    .sub{font-size:13px;color:var(--muted)}

    /* Start screen */
    .start-screen{
      display:flex;
      gap:18px;
      align-items:center;
      padding:18px;
      background: linear-gradient(180deg,#fffdf5,#fff8f0);
      border-radius:14px;
      margin-top:12px;
    }
    .start-left{flex:1}
    .mascot{
      width:160px;height:160px;border-radius:18px;background:
        radial-gradient(circle at 30% 30%, #fff 0 25%, transparent 26%),
        linear-gradient(135deg,#ffd4e0,#ffd7b3);
      display:flex;align-items:center;justify-content:center;flex-direction:column;
      box-shadow:0 8px 20px rgba(250,120,160,0.08);border:4px solid rgba(255,255,255,0.6);
      transform:rotate(-6deg);
    }
    .mascot .face{font-size:48px}
    .start-right{flex:2}
    .card-small{
      background: linear-gradient(180deg,#fff,#fffaf8);
      padding:12px;border-radius:12px;border:2px dashed rgba(0,0,0,0.04);
      margin-bottom:10px;
    }
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select,input[type="number"]{
      padding:8px 10px;border-radius:10px;border:2px solid #fff3f5;background:linear-gradient(180deg,#fff,#fffaf8);
      font-size:15px;color:#2b2b2b;box-shadow:0 4px 12px rgba(200,200,200,0.06);
    }
    button.primary{
      background:linear-gradient(180deg,var(--accent),#ff5f8e);
      color:white;border:0;padding:12px 18px;border-radius:14px;font-weight:800;font-size:16px;
      box-shadow:0 8px 22px rgba(255,122,160,0.14);cursor:pointer;
    }
    button.ghost{
      background:transparent;border:2px dashed rgba(0,0,0,0.06);padding:10px 14px;border-radius:12px;
      cursor:pointer;
    }

    /* Game area */
    .game{
      display:grid;
      grid-template-columns:1fr 320px;
      gap:16px;
      margin-top:18px;
      align-items:start;
    }
    @media (max-width:900px){ .game{grid-template-columns:1fr} .mascot{display:none} }
    .panel{background:linear-gradient(180deg,#fff,#fffcff);padding:14px;border-radius:14px;border:2px solid rgba(0,0,0,0.03)}
    .top-row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .meta-bubble{background:linear-gradient(180deg,#ffffff,#fffcef);padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);font-weight:700}
    .expr{
      font-size:56px;font-weight:900;color:#374151;display:flex;align-items:center;gap:12px;
      justify-content:center;padding:18px;border-radius:12px;background:linear-gradient(180deg,#fffcf6,#fff8f8);box-shadow:inset 0 -6px 18px rgba(255,120,150,0.03)
    }
    .expr .op{font-size:34px;color:#ff7aa2}
    .choices{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .choice{
      background:linear-gradient(180deg,#fff,#fff8fb);
      padding:12px;border-radius:12px;border:2px solid rgba(0,0,0,0.03);
      font-weight:900;font-size:20px;text-align:center;cursor:pointer;color:#2b2b2b;
      box-shadow:0 8px 18px rgba(30,60,100,0.04);transition:transform .12s ease, box-shadow .12s ease;
    }
    .choice:hover{transform:translateY(-6px)}
    .choice.correct{background:linear-gradient(180deg,#e6fff2,#dfffee);border-color:rgba(90,200,140,0.8);color:#257a4a;box-shadow:0 8px 30px rgba(60,180,120,0.08)}
    .choice.wrong{background:linear-gradient(180deg,#fff0f0,#fff2f2);border-color:rgba(255,120,120,0.6);color:#a12b2b}
    .feedback{font-size:16px;font-weight:800;padding:10px 12px;border-radius:10px;margin-top:10px;text-align:center}
    .feedback.good{background:linear-gradient(90deg,#fff7f9,#f5fff6);color:#2f8f6d}
    .feedback.bad{background:linear-gradient(90deg,#fff7f9,#fff7f7);color:#a63636}

    .side{
      display:flex;flex-direction:column;gap:12px;
    }
    .stat{
      background:linear-gradient(180deg,#fff,#fffefc);padding:12px;border-radius:12px;border:2px solid rgba(0,0,0,0.03);
      display:flex;justify-content:space-between;align-items:center;font-weight:900;
    }
    .log{background:linear-gradient(180deg,#fff,#fffaf8);padding:10px;border-radius:12px;border:1px dashed rgba(0,0,0,0.03);max-height:220px;overflow:auto;font-size:13px}

    .sound-config{
      background:linear-gradient(180deg,#fff,#fffefc);padding:10px;border-radius:12px;border:2px solid rgba(0,0,0,0.03);
      display:flex;flex-direction:column;gap:8px;font-size:13px;
    }
    .sound-row{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .hidden{display:none}

    /* End screen */
    .end-screen{
      display:none;padding:18px;border-radius:14px;background:linear-gradient(180deg,#fffdf8,#fff8f0);margin-top:14px;
      text-align:center;
    }
    .end-screen.show{display:block}
    .big-score{font-size:48px;color:var(--accent-2);font-weight:900;margin-top:6px}
    .cheer{font-size:20px;color:#ff6b93;margin-top:8px;font-weight:900}

  </style>
</head>
<body>
  <div class="wrap" role="application" aria-label="åŠ æ³•å°è¶…äººéŠæˆ²ï¼ˆéŸ³æ•ˆé¸é …ï¼‰">
    <header class="main">
      <div>
        <h1>åŠ æ³•å°è¶…äºº</h1>
        <div class="sub">è·Ÿè‘—å°è¶…äººå¿«æ¨‚ç·´ç¿’åŠ æ³•ï¼</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="enableSoundBtn" class="primary" title="é»æˆ‘é–‹å•Ÿè²éŸ³">é–‹è²éŸ³ ğŸ”Š</button>
        <div class="sub small">æç¤ºï¼šæŒ‰æ•¸å­—éµ 1â€“4 é¸ç­”æ¡ˆï¼ŒS éœéŸ³ / å–æ¶ˆéœéŸ³</div>
      </div>
    </header>

    <!-- Start screen -->
    <section class="start-screen" id="startScreen" aria-labelledby="startTitle">
      <div class="start-left">
        <div class="mascot" aria-hidden="true">
          <div class="face">ğŸ˜º</div>
          <div style="font-weight:900;margin-top:6px;color:#633">æˆ‘æ˜¯å°è¶…äºº</div>
        </div>
      </div>

      <div class="start-right">
        <div class="card-small" id="startTitle" style="font-weight:900;font-size:18px">éŠæˆ²èªªæ˜</div>
        <div class="card-small small" style="margin-top:8px">
          1. é¸æ“‡é›£åº¦å¾ŒæŒ‰ã€Œé–‹å§‹å†’éšªï¼ã€ã€‚<br>
          2. é¡Œå‹ï¼šåŠ æ³•ï¼ˆä¸æœƒå‡ºç¾ 0ï¼‰ã€‚<br>
          3. é›£åº¦èªªæ˜ï¼š<br>
          &nbsp;&nbsp;â€¢ ç°¡å–®ï¼šå€‹ä½ + å€‹ä½ï¼ˆ1â€“9 èˆ‡ 1â€“9ï¼‰<br>
          &nbsp;&nbsp;â€¢ ä¸­ç­‰ï¼šåä½ + å€‹ä½ï¼ˆ10â€“29 èˆ‡ 1â€“9ï¼Œä¸”ç­”æ¡ˆä¸è¶…é 30ï¼‰<br>
          4. æ¯é¡Œæœ‰ 4 å€‹é¸é …ï¼Œç­”å°æœƒæœ‰å¿«æ¨‚éŸ³æ•ˆï¼Œç­”éŒ¯æœ‰æç¤ºéŸ³ã€‚<br>
          5. åœ¨å³é‚Šå¯ä»¥è¨­å®šéŸ³æ•ˆç¨®é¡èˆ‡é è½ã€‚æŒ‰ä¸Šæ–¹ã€Œé–‹è²éŸ³ã€å¯ä¸€æ¬¡å•Ÿç”¨éŸ³æ•ˆï¼ˆè§£æ±ºç€è¦½å™¨è‡ªå‹•æ’­æ”¾é™åˆ¶ï¼‰ã€‚
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center" class="controls">
          <label class="small">é›£åº¦</label>
          <select id="difficulty" title="é¸æ“‡é›£åº¦">
            <option value="easy">ç°¡å–®ï¼ˆå€‹ä½+å€‹ä½ï¼‰</option>
            <option value="medium">ä¸­ç­‰ï¼ˆåä½+å€‹ä½ï¼Œç­”æ¡ˆ â‰¤ 30ï¼‰</option>
          </select>

          <button class="primary" id="startBtn">é–‹å§‹å†’éšªï¼</button>
          <button class="ghost" id="howBtn" type="button">å¦‚ä½•ç©</button>
        </div>

        <div class="small" style="margin-top:10px">é›£åº¦é©åˆ 6â€“9 æ­²çš„å°æœ‹å‹ã€‚ç¥ä½ ç©å¾—é–‹å¿ƒï¼</div>
      </div>
    </section>

    <!-- Game area -->
    <main class="game" id="gameArea" aria-hidden="true">
      <section class="panel" id="playPanel" aria-live="polite">
        <div class="top-row">
          <div class="meta-bubble" id="progress">ç¬¬ 0 é¡Œ</div>
          <div class="meta-bubble" id="timer">æ™‚é–“: 0s</div>
          <div class="meta-bubble" id="score">åˆ†æ•¸: 0</div>
        </div>

        <div class="expr" role="img" aria-label="ç¾åœ¨é¡Œç›®">
          <div id="a" style="min-width:48px;text-align:right">0</div>
          <div class="op">+</div>
          <div id="b" style="min-width:48px;text-align:left">0</div>
          <div style="font-size:28px;color:#999">=</div>
          <div id="q" style="min-width:60px;text-align:center">?</div>
        </div>

        <div class="choices" id="choices" aria-label="é¸é …å€">
          <!-- options -->
        </div>

        <div id="feedback" class="feedback small" style="visibility:hidden">æº–å‚™å¥½äº†ï¼</div>

        <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
          <button id="nextBtn" class="ghost hidden">ä¸‹ä¸€é¡Œ</button>
        </div>
      </section>

      <aside class="side">
        <div class="stat">
          <div>
            <div class="small">ç­”å°</div>
            <div id="correctCount" style="font-size:20px;color:#2b9f6b;font-weight:900">0</div>
          </div>
          <div>
            <div class="small">ç­”éŒ¯</div>
            <div id="wrongCount" style="font-size:20px;color:#d04e4e;font-weight:900">0</div>
          </div>
        </div>

        <div class="stat">
          <div>
            <div class="small">é¡Œç›®ç¸½æ•¸</div>
            <div id="totalCount" style="font-size:18px;font-weight:900">10</div>
          </div>
          <div>
            <div class="small">å·²ä½œé¡Œæ•¸</div>
            <div id="currentNum" style="font-size:18px;font-weight:900">0</div>
          </div>
        </div>

        <div class="log small" id="log" aria-live="polite">
          æ­¡è¿ï¼æŒ‰ã€Œé–‹å§‹å†’éšªã€é–‹å§‹ä½ çš„ä»»å‹™ã€‚
        </div>

        <div class="sound-config" aria-label="éŸ³æ•ˆè¨­å®š">
          <div style="font-weight:900">éŸ³æ•ˆè¨­å®š</div>

          <div class="sound-row">
            <label class="small" style="min-width:78px">æ­£ç¢ºéŸ³æ•ˆ</label>
            <select id="correctSoundSelect" style="flex:1">
              <option value="default">é è¨­ï¼ˆå½ˆè·³ï¼‰</option>
              <option value="soft">æŸ”å’Œï¼ˆæº«æŸ”é¼“æŒï¼‰</option>
              <option value="clap">é¼“æŒï¼ˆæ­¡å‘¼ï¼‰</option>
              <option value="none">ç„¡è²</option>
            </select>
            <button id="previewCorrect" class="ghost" type="button">é è½</button>
          </div>

          <div class="sound-row">
            <label class="small" style="min-width:78px">éŒ¯èª¤éŸ³æ•ˆ</label>
            <select id="wrongSoundSelect" style="flex:1">
              <option value="default">é è¨­ï¼ˆè¼•å—¶ï¼‰</option>
              <option value="soft">æº«å’Œï¼ˆè¼•æ•²ï¼‰</option>
              <option value="buzz">å—¶â€”ï¼ˆçŸ­ä¿ƒï¼‰</option>
              <option value="none">ç„¡è²</option>
            </select>
            <button id="previewWrong" class="ghost" type="button">é è½</button>
          </div>

          <div class="sound-row" style="justify-content:space-between;align-items:center">
            <div style="display:flex;gap:8px;align-items:center">
              <label class="small">å…¨åŸŸè²éŸ³</label>
              <button id="toggleSoundBtn" class="ghost" type="button">éœéŸ³</button>
            </div>
            <div class="small">æŒ‰ S å¯åˆ‡æ›éœéŸ³</div>
          </div>

          <div class="sound-row" style="margin-top:6px;gap:6px">
            <button id="enableSoundQuick" class="primary" style="flex:1">é–‹è²éŸ³ï¼ˆå¿«æ·ï¼‰</button>
            <div class="small" style="align-self:center">é»æ“Šä»¥å•Ÿç”¨æ‰€æœ‰é è½èˆ‡éŠæˆ²éŸ³æ•ˆ</div>
          </div>

        </div>

        <div style="margin-top:auto">
          <button id="resetBtn" class="ghost" type="button">é‡è¨­éŠæˆ²</button>
        </div>
      </aside>
    </main>

    <!-- End screen -->
    <section class="end-screen" id="endScreen" aria-hidden="true">
      <div style="font-weight:900;font-size:22px;color:#333">ä»»å‹™å®Œæˆï¼å°è¶…äººå¾ˆé©•å‚²ä½ ï¼</div>
      <div class="big-score" id="finalScore">åˆ†æ•¸ï¼š0</div>
      <div id="finalSummary" class="small" style="margin-top:6px"></div>
      <div class="cheer" id="cheerText">ä½ çœŸæ£’ï¼å†æ¥å†å²ï¼ğŸ‰</div>

      <div style="margin-top:12px;display:flex;gap:12px;justify-content:center">
        <button class="primary" id="replayBtn">å†ç©ä¸€æ¬¡</button>
        <button class="ghost" id="toStartBtn" type="button">å›åˆ°ä¸»ç•«é¢</button>
      </div>
    </section>

  </div>

  <!-- Audio elements -->
  <!-- NOTE: These base64 audio data are placeholders (silent). Replace with real short clips for good UX. -->
  <audio id="snd_correct_default" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>
  <audio id="snd_correct_soft" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>
  <audio id="snd_correct_clap" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <audio id="snd_wrong_default" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>
  <audio id="snd_wrong_soft" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>
  <audio id="snd_wrong_buzz" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <script>
    // DOM
    const startScreen = document.getElementById('startScreen');
    const startBtn = document.getElementById('startBtn');
    const howBtn = document.getElementById('howBtn');
    const difficultyEl = document.getElementById('difficulty');
    const gameArea = document.getElementById('gameArea');
    const aEl = document.getElementById('a');
    const bEl = document.getElementById('b');
    const qEl = document.getElementById('q');
    const choicesEl = document.getElementById('choices');
    const progressEl = document.getElementById('progress');
    const timerEl = document.getElementById('timer');
    const scoreEl = document.getElementById('score');
    const feedbackEl = document.getElementById('feedback');
    const nextBtn = document.getElementById('nextBtn');
    const correctCountEl = document.getElementById('correctCount');
    const wrongCountEl = document.getElementById('wrongCount');
    const totalCountEl = document.getElementById('totalCount');
    const currentNumEl = document.getElementById('currentNum');
    const logEl = document.getElementById('log');
    const resetBtn = document.getElementById('resetBtn');
    const endScreen = document.getElementById('endScreen');
    const finalScoreEl = document.getElementById('finalScore');
    const finalSummaryEl = document.getElementById('finalSummary');
    const cheerTextEl = document.getElementById('cheerText');
    const replayBtn = document.getElementById('replayBtn');
    const toStartBtn = document.getElementById('toStartBtn');

    // sound controls
    const correctSoundSelect = document.getElementById('correctSoundSelect');
    const wrongSoundSelect = document.getElementById('wrongSoundSelect');
    const previewCorrect = document.getElementById('previewCorrect');
    const previewWrong = document.getElementById('previewWrong');
    const toggleSoundBtn = document.getElementById('toggleSoundBtn');
    const enableSoundBtn = document.getElementById('enableSoundBtn');
    const enableSoundQuick = document.getElementById('enableSoundQuick');

    // audio elements map
    const audioMap = {
      correct: {
        default: document.getElementById('snd_correct_default'),
        soft: document.getElementById('snd_correct_soft'),
        clap: document.getElementById('snd_correct_clap'),
        none: null
      },
      wrong: {
        default: document.getElementById('snd_wrong_default'),
        soft: document.getElementById('snd_wrong_soft'),
        buzz: document.getElementById('snd_wrong_buzz'),
        none: null
      }
    };

    // state
    let state = {
      running: false,
      difficulty: 'easy',
      total: 10,
      currentIndex: 0,
      correct: 0,
      wrong: 0,
      score: 0,
      startTime: 0,
      timerInterval: null,
      currentQuestion: null,
      muted: true // start muted until user enables via button
    };

    totalCountEl.textContent = state.total;
    updateToggleButton();

    // Helpers
    function randInt(min, max){
      return Math.floor(Math.random()*(max-min+1))+min;
    }

    function genOperands(difficulty){
      if(difficulty === 'easy'){
        const a = randInt(1,9);
        const b = randInt(1,9);
        return [a,b];
      } else {
        const b = randInt(1,9);
        const maxA = Math.min(29, 30 - b);
        const minA = 10;
        if(maxA < minA){
          let nb = b;
          while(nb > 1 && (30 - nb) < minA) nb--;
          const b2 = nb;
          const maxA2 = Math.min(29, 30 - b2);
          const a2 = randInt(minA, Math.max(minA, maxA2));
          return [a2, b2];
        }
        const a = randInt(minA, maxA);
        return [a,b];
      }
    }

    function makeQuestion(){
      const [a,b] = genOperands(state.difficulty);
      const answer = a + b;
      const opts = new Set();
      opts.add(answer);
      const spread = Math.max(3, Math.floor(answer * 0.25) + 1);
      while(opts.size < 4){
        let delta = randInt(1, Math.max(3, spread));
        let sign = Math.random() < 0.5 ? -1 : 1;
        let candidate = answer + sign * delta;
        if(candidate <= 0) candidate = Math.abs(candidate) + 1;
        opts.add(candidate);
      }
      const arr = Array.from(opts);
      for(let i = arr.length - 1; i > 0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return {a,b,answer,choices:arr};
    }

    function updateTimer(){
      if(!state.running) return;
      const sec = Math.floor((Date.now() - state.startTime)/1000);
      timerEl.textContent = 'æ™‚é–“: ' + sec + 's';
    }

    function showStartScreen(){
      startScreen.style.display = 'flex';
      gameArea.setAttribute('aria-hidden','true');
      gameArea.style.display = 'none';
      endScreen.setAttribute('aria-hidden','true');
      endScreen.classList.remove('show');
      state.running = false;
      clearInterval(state.timerInterval);
      timerEl.textContent = 'æ™‚é–“: 0s';
      scoreEl.textContent = 'åˆ†æ•¸: 0';
      progressEl.textContent = 'ç¬¬ 0 é¡Œ';
      aEl.textContent = '0';
      bEl.textContent = '0';
      qEl.textContent = '?';
    }

    function startGame(){
      startScreen.style.display = 'none';
      gameArea.style.display = 'grid';
      gameArea.setAttribute('aria-hidden','false');
      endScreen.setAttribute('aria-hidden','true');
      endScreen.classList.remove('show');

      state.running = true;
      state.difficulty = difficultyEl.value;
      state.total = 10;
      state.currentIndex = 0;
      state.correct = 0;
      state.wrong = 0;
      state.score = 0;
      state.startTime = Date.now();
      clearInterval(state.timerInterval);
      state.timerInterval = setInterval(updateTimer, 300);
      updateTimer();

      totalCountEl.textContent = state.total;
      correctCountEl.textContent = '0';
      wrongCountEl.textContent = '0';
      currentNumEl.textContent = '0';
      logEl.innerHTML = '<div>æº–å‚™å‡ºé¡Œï¼åŠ æ²¹ï½</div>';
      feedbackEl.style.visibility = 'hidden';
      scoreEl.textContent = 'åˆ†æ•¸: 0';
      nextBtn.classList.add('hidden');

      showQuestion();
    }

    function showQuestion(){
      state.currentQuestion = makeQuestion();
      state.currentIndex += 1;
      aEl.textContent = state.currentQuestion.a;
      bEl.textContent = state.currentQuestion.b;
      qEl.textContent = '?';
      progressEl.textContent = `ç¬¬ ${state.currentIndex} é¡Œ / ${state.total}`;
      currentNumEl.textContent = state.currentIndex;
      scoreEl.textContent = 'åˆ†æ•¸: ' + state.score;

      choicesEl.innerHTML = '';
      state.currentQuestion.choices.forEach((c, idx) => {
        const d = document.createElement('div');
        d.className = 'choice';
        d.setAttribute('role','button');
        d.setAttribute('tabindex','0');
        d.dataset.value = c;
        d.innerText = c;
        d.addEventListener('click', onChoice);
        d.addEventListener('keydown', (e)=>{
          if(e.key === 'Enter' || e.key === ' ') onChoice({target:d});
        });
        choicesEl.appendChild(d);
      });

      document.onkeydown = function(e){
        if(!state.running) return;
        if(e.key >= '1' && e.key <= '4'){
          const idx = parseInt(e.key)-1;
          const child = choicesEl.children[idx];
          if(child) child.click();
        } else if(e.key === 'Enter'){
          if(!nextBtn.classList.contains('hidden')) nextBtn.click();
        } else if(e.key.toLowerCase() === 's'){
          state.muted = !state.muted;
          updateToggleButton();
          logEl.insertAdjacentHTML('afterbegin', `<div class="small">${state.muted ? 'å·²éœéŸ³' : 'è²éŸ³é–‹å•Ÿ'}</div>`);
        }
      };
    }

    function endIfNeeded(){
      if(state.currentIndex >= state.total){
        finishGame();
        return true;
      }
      return false;
    }

    function finishGame(){
      state.running = false;
      clearInterval(state.timerInterval);
      endScreen.setAttribute('aria-hidden','false');
      endScreen.classList.add('show');
      gameArea.setAttribute('aria-hidden','true');

      const elapsed = Math.floor((Date.now() - state.startTime)/1000);
      finalScoreEl.textContent = 'åˆ†æ•¸ï¼š' + state.score;
      const accuracy = state.currentIndex ? Math.round((state.correct/state.currentIndex)*100) : 0;
      finalSummaryEl.innerHTML = `é¡Œæ•¸ï¼š${state.currentIndex} é¡Œ &nbsp; ç­”å°ï¼š${state.correct} é¡Œ &nbsp; ç­”éŒ¯ï¼š${state.wrong} é¡Œ<br>ç”¨æ™‚ï¼š${elapsed}s &nbsp; æ­£ç¢ºç‡ï¼š${accuracy}%`;

      let cheer = 'ä½ çœŸæ£’ï¼å†æ¥å†å²ï¼ğŸ‰';
      if(accuracy >= 90 && state.score >= state.currentIndex*10 - 5) cheer = 'å¤ªå²å®³äº†ï¼ä½ æ˜¯åŠ æ³•å°è¶…äººï¼ğŸš€';
      else if(accuracy >= 70) cheer = 'å¥½æ£’å–”ï¼Œç¹¼çºŒç·´ç¿’æœƒæ›´å¿«å–”ï¼ğŸŒŸ';
      else if(accuracy >= 40) cheer = 'ä¸éŒ¯å”·ï¼Œå¤šç·´ç¿’å°±æ›´å²å®³äº†ï¼ğŸ’ª';
      else cheer = 'æ²’é—œä¿‚ï¼Œå¤±æ•—æ˜¯å­¸ç¿’çš„å¥½æœ‹å‹ï¼ä¸‹æ¬¡æ›´æ£’ï¼ğŸ’–';
      cheerTextEl.textContent = cheer;

      logEl.insertAdjacentHTML('afterbegin', `<div class="small">å®Œæˆï¼š${state.score} åˆ†ï¼Œ${accuracy}%</div>`);
    }

    function onChoice(e){
      if(!state.running) return;
      const target = e.target;
      if(target.classList.contains('correct') || target.classList.contains('wrong')) return;
      const val = Number(target.dataset.value);
      const correct = state.currentQuestion.answer;

      Array.from(choicesEl.children).forEach(c=>{
        c.classList.add('disabled');
        const cv = Number(c.dataset.value);
        if(cv === correct) c.classList.add('correct');
      });

      qEl.textContent = correct;
      if(val === correct){
        state.correct += 1;
        state.score += 10;
        feedbackEl.textContent = 'å¤ªæ£’äº†ï¼ç­”å°äº†ï¼ +10 åˆ†';
        feedbackEl.className = 'feedback good';
        feedbackEl.style.visibility = 'visible';
        playConfiguredSound('correct');
        correctCountEl.textContent = state.correct;
      } else {
        target.classList.add('wrong');
        state.wrong += 1;
        state.score = Math.max(0, state.score - 5);
        feedbackEl.textContent = 'æ²’é—œä¿‚ï¼Œä¸‹æ¬¡æ›´å¥½ï¼';
        feedbackEl.className = 'feedback bad';
        feedbackEl.style.visibility = 'visible';
        playConfiguredSound('wrong');
        wrongCountEl.textContent = state.wrong;
      }
      scoreEl.textContent = 'åˆ†æ•¸: ' + state.score;

      const logLine = `${state.currentIndex}. ${state.currentQuestion.a} + ${state.currentQuestion.b} = ${correct} â†’ ä½ çš„ç­”æ¡ˆï¼š${val} ${val===correct ? 'ï¼ˆç­”å°ï¼‰' : 'ï¼ˆç­”éŒ¯ï¼‰'}`;
      logEl.insertAdjacentHTML('afterbegin', `<div class="small">${logLine}</div>`);

      if(!endIfNeeded()){
        nextBtn.classList.remove('hidden');
      } else {
        nextBtn.classList.add('hidden');
      }
    }

    // Sound playback according to selection
    function playConfiguredSound(kind){
      if(state.muted) return;
      const sel = kind === 'correct' ? correctSoundSelect.value : wrongSoundSelect.value;
      const audioEl = audioMap[kind][sel];
      if(!audioEl) return;
      try{
        audioEl.currentTime = 0;
        audioEl.play().catch(()=>{});
      }catch(e){}
    }

    // Preview buttons
    previewCorrect.addEventListener('click', ()=>{
      const sel = correctSoundSelect.value;
      const el = audioMap.correct[sel];
      if(!el){
        logEl.insertAdjacentHTML('afterbegin', `<div class="small">æ­£ç¢ºéŸ³æ•ˆï¼šç„¡è²</div>`);
        return;
      }
      try{
        el.currentTime = 0;
        el.play();
        logEl.insertAdjacentHTML('afterbegin', `<div class="small">é è½æ­£ç¢ºéŸ³æ•ˆï¼š${sel}</div>`);
      }catch(e){}
    });

    previewWrong.addEventListener('click', ()=>{
      const sel = wrongSoundSelect.value;
      const el = audioMap.wrong[sel];
      if(!el){
        logEl.insertAdjacentHTML('afterbegin', `<div class="small">éŒ¯èª¤éŸ³æ•ˆï¼šç„¡è²</div>`);
        return;
      }
      try{
        el.currentTime = 0;
        el.play();
        logEl.insertAdjacentHTML('afterbegin', `<div class="small">é è½éŒ¯èª¤éŸ³æ•ˆï¼š${sel}</div>`);
      }catch(e){}
    });

    // Toggle global sound
    toggleSoundBtn.addEventListener('click', ()=>{
      state.muted = !state.muted;
      updateToggleButton();
      logEl.insertAdjacentHTML('afterbegin', `<div class="small">${state.muted ? 'å·²éœéŸ³' : 'è²éŸ³é–‹å•Ÿ'}</div>`);
    });

    function updateToggleButton(){
      toggleSoundBtn.textContent = state.muted ? 'å–æ¶ˆéœéŸ³' : 'éœéŸ³';
      // also visually update enableSoundBtn
      enableSoundBtn.disabled = !state.muted;
      enableSoundQuick.disabled = !state.muted;
    }

    // Enable sound button: plays a very short sound under user interaction to unlock audio in browser
    enableSoundBtn.addEventListener('click', ()=>{ enableAllSounds(true); });
    enableSoundQuick.addEventListener('click', ()=>{ enableAllSounds(true); });

    function enableAllSounds(unmute = true){
      // Try playing a very short sound from each available audio element to "prime" audio playback
      try{
        // Temporarily unmute to play the test
        const prevMuted = state.muted;
        if(unmute) state.muted = false;
        const testEls = [
          audioMap.correct.default,
          audioMap.correct.soft,
          audioMap.correct.clap,
          audioMap.wrong.default,
          audioMap.wrong.soft,
          audioMap.wrong.buzz
        ].filter(Boolean);
        // play them quickly (only first will be heard)
        for(const el of testEls){
          try{ el.currentTime = 0; el.play().catch(()=>{}); }catch(e){}
        }
        // update state
        state.muted = !unmute ? prevMuted : false;
        updateToggleButton();
        logEl.insertAdjacentHTML('afterbegin', `<div class="small">å·²å•Ÿç”¨è²éŸ³ï¼Œç¾åœ¨å¯é è½èˆ‡æ’­æ”¾éŸ³æ•ˆã€‚</div>`);
      }catch(e){
        logEl.insertAdjacentHTML('afterbegin', `<div class="small">ç„¡æ³•å•Ÿç”¨è²éŸ³ï¼ˆç€è¦½å™¨é™åˆ¶ï¼‰</div>`);
      }
    }

    // Buttons
    startBtn.addEventListener('click', startGame);
    howBtn.addEventListener('click', ()=>{
      alert('ç©æ³•èªªæ˜ï¼š\n\né¸å¥½é›£åº¦å¾ŒæŒ‰ã€Œé–‹å§‹å†’éšªï¼ã€ã€‚æ¯é¡Œé¸å‡ºæ­£ç¢ºç­”æ¡ˆï¼Œç­”å°æœƒæœ‰é¼“å‹µéŸ³æ•ˆï¼Œç­”éŒ¯æœƒæœ‰æç¤ºéŸ³ã€‚ä½ å¯åœ¨å³å´è¨­å®šéŸ³æ•ˆç¨®é¡ä¸¦é è½ã€‚æŒ‰ä¸Šæ–¹ã€Œé–‹è²éŸ³ã€æˆ–å³å´ã€Œé–‹è²éŸ³ï¼ˆå¿«æ·ï¼‰ã€ä¾†å•Ÿç”¨éŸ³æ•ˆï¼ˆç€è¦½å™¨å¯èƒ½è¦æ±‚ä½¿ç”¨è€…äº’å‹•ä»¥å…è¨±æ’­æ”¾ï¼‰ã€‚æŒ‰ S å¯åˆ‡æ›éœéŸ³ã€‚');
    });

    nextBtn.addEventListener('click', ()=>{
      nextBtn.classList.add('hidden');
      feedbackEl.style.visibility = 'hidden';
      setTimeout(()=>{ showQuestion(); }, 220);
    });

    resetBtn.addEventListener('click', ()=>{
      showStartScreen();
    });

    replayBtn.addEventListener('click', ()=>{
      endScreen.classList.remove('show');
      startScreen.style.display = 'none';
      gameArea.style.display = 'grid';
      startGame();
    });

    toStartBtn.addEventListener('click', showStartScreen);

    document.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase() === 's'){
        state.muted = !state.muted;
        updateToggleButton();
        logEl.insertAdjacentHTML('afterbegin', `<div class="small">${state.muted ? 'å·²éœéŸ³' : 'è²éŸ³é–‹å•Ÿ'}</div>`);
      }
    });

    // Initial
    showStartScreen();
    window.addEventListener('load', ()=>{ startBtn.focus(); });

  </script>
</body>
</html>
