<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Husky Calculation Battle</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style type="text/tailwindcss">
        /* Custom Animations */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } }
        @keyframes damage-flash { 0%, 100% { opacity: 1; filter: none; } 50% { opacity: 0.5; filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } }
        @keyframes hit-flash-red { 0%, 100% { filter: none; } 50% { filter: drop-shadow(0 0 10px red) sepia(1) hue-rotate(-50deg) saturate(5); } }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pop-in { 0% { transform: scale(0) rotate(-10deg); opacity: 0; } 50% { transform: scale(1.2) rotate(5deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); opacity: 1; } }
        @keyframes rays { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse-red { 0%, 100% { box-shadow: inset 0 0 0px rgba(220, 38, 38, 0); } 50% { box-shadow: inset 0 0 30px rgba(220, 38, 38, 0.6); } }
        @keyframes time-up-doom { 0% { filter: grayscale(0); transform: scale(1); } 100% { filter: grayscale(1) brightness(0.7); transform: scale(0.95); } }
        
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        .animate-damage { animation: damage-flash 0.2s ease-in-out 2; }
        .animate-hit { animation: hit-flash-red 0.3s ease-in-out; }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
        .animate-spin-slow { animation: spin-slow 4s linear infinite; }
        .animate-pop-in { animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-rays { animation: rays 10s linear infinite; }
        
        .low-health { animation: pulse-red 1.5s infinite; border: 2px solid rgba(220, 38, 38, 0.5); }
        .time-up-effect { animation: time-up-doom 1.5s forwards; pointer-events: none; }
        .boss-sprite { transform: scale(1.3); filter: drop-shadow(0 0 15px rgba(239, 68, 68, 0.8)) saturate(1.5); }
        .pixelated { image-rendering: pixelated; }
        
        .screen { display: none; }
        .screen.active { display: flex; }
        .timer-bar { transition: width 0.1s linear; }
        .levelup-text { text-shadow: 4px 4px 0px #000, -2px -2px 0px #000; }
        .numpad-btn { @apply bg-slate-700 text-white font-bold rounded-lg shadow-md active:bg-slate-600 active:scale-95 transition-transform flex items-center justify-center text-xl select-none; height: 44px; }
        
        /* Leaderboard Styles */
        .leaderboard-item:nth-child(1) .rank { color: #fbbf24; } 
        .leaderboard-item:nth-child(2) .rank { color: #9ca3af; } 
        .leaderboard-item:nth-child(3) .rank { color: #b45309; } 
    </style>
</head>
<body class="font-sans overflow-hidden bg-slate-900 text-slate-800 touch-manipulation h-[100dvh]">

    <!-- Global Timer -->
    <div id="global-timer-container" class="fixed top-2 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="bg-slate-800/90 text-white border-2 border-yellow-400 px-4 py-1 rounded-2xl font-mono text-xl font-bold shadow-2xl flex items-center gap-2">
            <i data-lucide="clock" class="w-4 h-4 text-yellow-400"></i>
            <span id="global-time-display">90</span>
        </div>
    </div>

    <!-- Level Up Overlay -->
    <div id="levelup-overlay" class="fixed inset-0 z-[60] bg-black/80 hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="absolute inset-0 flex items-center justify-center overflow-hidden z-0">
            <div class="w-[200vmax] h-[200vmax] bg-[conic-gradient(from_0deg,transparent_0_20deg,#fbbf24_20deg_40deg,transparent_40deg_60deg,#fbbf24_60deg_80deg,transparent_80deg_100deg,#fbbf24_100deg_120deg,transparent_120deg_140deg,#fbbf24_140deg_160deg,transparent_160deg_180deg,#fbbf24_180deg_200deg,transparent_200deg_220deg,#fbbf24_220deg_240deg,transparent_240deg_260deg,#fbbf24_260deg_280deg,transparent_280deg_300deg,#fbbf24_300deg_320deg,transparent_320deg_340deg,#fbbf24_340deg_360deg)] opacity-20 animate-rays"></div>
        </div>
        <div class="relative z-10 flex flex-col items-center animate-pop-in">
            <h1 class="text-6xl md:text-8xl font-black text-yellow-400 levelup-text mb-8 transform -rotate-6 tracking-wider text-center">LEVEL UP!</h1>
            <img src="Husky6.png" class="w-48 h-48 md:w-64 md:h-64 object-contain drop-shadow-[0_0_30px_rgba(250,204,21,0.8)] animate-bounce">
            <div class="mt-8 text-white text-xl md:text-2xl font-bold bg-slate-800/80 px-6 py-2 rounded-full border-2 border-yellow-400">Speed Up!</div>
        </div>
    </div>

    <!-- Victory Overlay -->
    <div id="victory-overlay" class="fixed inset-0 z-[70] bg-blue-900/90 hidden flex flex-col items-center justify-center backdrop-blur-md">
        <div class="absolute inset-0 flex items-center justify-center overflow-hidden z-0">
            <div class="w-[200vmax] h-[200vmax] bg-[conic-gradient(from_0deg,transparent_0_20deg,#60a5fa_20deg_40deg,transparent_40deg_60deg,#60a5fa_60deg_80deg,transparent_80deg_100deg,#60a5fa_100deg_120deg,transparent_120deg_140deg,#60a5fa_140deg_160deg,transparent_160deg_180deg,#60a5fa_180deg_200deg,transparent_200deg_220deg,#60a5fa_220deg_240deg,transparent_240deg_260deg,#60a5fa_260deg_280deg,transparent_280deg_300deg,#60a5fa_300deg_320deg,transparent_320deg_340deg,#60a5fa_340deg_360deg)] opacity-30 animate-rays"></div>
        </div>
        <div class="relative z-10 flex flex-col items-center animate-pop-in text-center p-4">
            <h1 class="text-6xl md:text-8xl font-black text-yellow-300 mb-4 drop-shadow-[0_5px_5px_rgba(0,0,0,0.5)]">VICTORY!</h1>
            <div class="text-white text-2xl md:text-3xl font-bold mb-8">Boss Defeated!</div>
            <img src="Husky5.png" class="w-64 h-64 object-contain drop-shadow-[0_0_30px_rgba(255,255,255,0.8)] animate-bounce">
        </div>
    </div>

    <!-- SCREEN 1: START MENU -->
    <div id="start-screen" class="screen active h-full w-full bg-red-600 items-center justify-center p-4 relative overflow-hidden">
        <button onclick="toggleLanguage()" class="absolute top-4 right-4 z-50 bg-white/20 backdrop-blur-md border border-white/40 text-white font-bold py-2 px-4 rounded-full hover:bg-white/30 transition-all flex items-center gap-2 shadow-lg">
            <i data-lucide="globe" class="w-4 h-4"></i><span class="lang-btn-text">‰∏≠Êñá</span>
        </button>
        <div class="absolute inset-0 bg-gradient-to-br from-red-500 to-red-700"></div>
        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full transform translate-x-1/2 -translate-y-1/2"></div>
        
        <div class="bg-white/95 backdrop-blur-md border-4 border-slate-800 rounded-3xl p-6 max-w-md w-full text-center shadow-2xl relative z-10 max-h-[90dvh] overflow-y-auto">
            <div class="flex justify-center mb-2 mt-2">
                 <img src="Husky4.png" class="w-32 h-32 md:w-40 md:h-40 object-contain animate-bounce drop-shadow-2xl">
            </div>
            <h1 id="title-text" class="text-2xl md:text-3xl font-extrabold mb-2 text-slate-800 tracking-tight">Husky Calculation Battle</h1>
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-3 mb-6 text-left shadow-sm">
                <h3 id="instr-title" class="font-bold text-yellow-800 mb-2 flex items-center gap-2 text-sm"><i data-lucide="info" class="w-4 h-4"></i> How to Play</h3>
                <ul id="instr-list" class="text-xs md:text-sm text-yellow-900 space-y-1 list-disc list-inside font-medium">
                    <li>Type answer using keypad.</li>
                    <li>Game Time: <strong>90s</strong>. Max Level: <strong>5</strong>.</li>
                    <li>Correct answers deal damage.</li>
                    <li>Defeat a monster to <strong>Level Up</strong> & heal!</li>
                    <li><strong>Warning:</strong> Monster attacks back!</li>
                </ul>
            </div>
            <button onclick="startGame()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 md:py-4 px-8 rounded-xl text-lg md:text-xl transition-all transform hover:scale-105 shadow-lg border-b-4 border-blue-800 flex items-center justify-center gap-3 active:translate-y-1 active:shadow-none">
                <i data-lucide="play" class="w-5 h-5 md:w-6 md:h-6 fill-current"></i> <span id="start-btn-text">Start Adventure</span>
            </button>
        </div>
    </div>

    <!-- SCREEN 2: GAMEPLAY -->
    <div id="game-screen" class="screen h-[100dvh] w-full bg-slate-800 flex-col items-center relative overflow-hidden">
        <div class="w-full h-[30vh] md:h-[45vh] relative bg-gradient-to-b from-blue-300 to-green-300 flex justify-center overflow-hidden border-b-4 border-slate-900 shrink-0">
             <div class="absolute bottom-0 w-full h-12 bg-green-600 skew-y-1 transform origin-bottom-right opacity-80"></div>
             <div class="absolute bottom-4 w-full h-12 bg-green-500 -skew-y-2 transform origin-bottom-left"></div>
             <div class="w-full max-w-4xl relative h-full">
                <div id="player-container" class="absolute bottom-0 left-2 z-20 transition-all duration-300">
                    <div class="relative group">
                        <div id="attack-effect" class="hidden absolute top-0 -right-10 z-30 animate-ping">
                           <i data-lucide="zap" class="text-yellow-400 fill-yellow-400 w-12 h-12 md:w-16 md:h-16 drop-shadow-lg"></i>
                        </div>
                        <img id="player-sprite" src="Husky1.png" class="w-24 md:w-48 h-auto object-contain drop-shadow-xl">
                        <div class="absolute left-[100%] top-1/2 transform -translate-y-1/2 bg-white/90 text-slate-800 p-1.5 rounded-lg border-2 border-slate-600 shadow-lg text-[10px] md:text-xs font-bold min-w-[90px] md:min-w-[120px] ml-1">
                            <div class="mb-0.5 md:mb-1 font-black text-slate-900">Husky</div>
                            <div class="flex justify-between items-center mb-0.5"><span class="text-slate-500 mr-1">HP</span><span id="player-hp-text">100</span></div>
                            <div class="w-full h-1.5 md:h-2 bg-slate-200 rounded-full border border-slate-300 overflow-hidden mb-0.5"><div id="player-hp-bar" class="h-full bg-green-500 w-full transition-all duration-300"></div></div>
                        </div>
                    </div>
                </div>
                <div id="enemy-container" class="absolute top-14 right-2 z-10 transition-all duration-500">
                     <div class="relative">
                        <div id="boss-badge" class="hidden absolute -top-6 left-1/2 transform -translate-x-1/2 bg-red-600 text-white font-black text-[10px] md:text-xs px-2 py-0.5 rounded shadow-lg border border-red-400 z-20 animate-bounce">BOSS</div>
                        <div id="monster-attack-effect" class="hidden absolute bottom-0 -left-10 z-30 animate-ping"><i data-lucide="swords" class="text-red-500 fill-red-500 w-12 h-12 md:w-16 md:h-16 drop-shadow-lg"></i></div>
                        <img id="enemy-sprite" src="" class="w-24 h-24 md:w-32 md:h-32 md:w-48 md:h-48 object-contain pixelated animate-float transition-all duration-300">
                        <div class="absolute right-[100%] top-1/2 transform -translate-y-1/2 bg-white/90 p-1.5 rounded-lg border-2 border-slate-700 shadow-lg text-[10px] md:text-xs font-bold min-w-[90px] md:min-w-[130px] mr-1">
                            <div class="flex justify-between mb-0.5 md:mb-1"><span id="enemy-name" class="font-black text-slate-900">Monster</span></div>
                            <div class="flex justify-between items-center mb-0.5"><span class="text-slate-500 mr-1">HP</span><span id="enemy-hp-text"></span></div>
                            <div class="w-full h-1.5 md:h-2 bg-slate-200 rounded-full border border-slate-300 overflow-hidden mb-0.5"><div id="enemy-hp-bar" class="h-full bg-green-500 w-full transition-all duration-500"></div></div>
                            <div class="flex justify-between items-center"><span class="text-red-500 mr-1 font-black">ATK</span><span id="enemy-atk-text"></span></div>
                        </div>
                     </div>
                </div>
             </div>
        </div>
        <div class="flex-1 w-full bg-slate-800 flex flex-col items-center justify-start relative z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.5)] border-t border-slate-700 overflow-y-auto">
            <div class="w-full max-w-lg p-2 h-full flex flex-col pb-8">
               <div class="flex items-center justify-between gap-2 mb-2 bg-slate-700/50 p-1.5 rounded-xl border border-slate-600 shrink-0">
                    <button onclick="endGame('defeat')" class="bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 text-red-300 p-2 rounded-lg transition-all" title="Restart"><i data-lucide="refresh-ccw" class="w-4 h-4"></i></button>
                    <div class="flex-1 flex items-center justify-center gap-2 md:gap-4">
                        <div class="flex flex-col items-center justify-center bg-slate-800/50 rounded-lg px-2 md:px-4 py-1 min-w-[60px]">
                            <div id="score-label" class="text-[8px] md:text-[9px] font-bold text-slate-400 uppercase leading-none mb-0.5">Score</div>
                            <div id="score-display" class="text-lg md:text-xl font-black text-white leading-none">0</div>
                        </div>
                        <div class="flex flex-col items-center justify-center bg-slate-800/50 rounded-lg px-2 md:px-4 py-1 min-w-[60px]">
                            <div id="level-label" class="text-[8px] md:text-[9px] font-bold text-slate-400 uppercase leading-none mb-0.5">Level</div>
                            <div id="level-text" class="text-lg md:text-xl font-black text-white leading-none">1</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button id="mute-btn" onclick="toggleMute()" class="bg-slate-600 hover:bg-slate-500 border border-slate-500 text-slate-300 p-2 rounded-lg transition-all" title="Sound"><i id="mute-icon" data-lucide="volume-2" class="w-4 h-4"></i></button>
                        <button onclick="toggleLanguage()" class="bg-slate-600 hover:bg-slate-500 border border-slate-500 text-slate-300 p-2 rounded-lg transition-all" title="Language"><i data-lucide="globe" class="w-4 h-4"></i></button>
                    </div>
               </div>
               <div class="w-full h-3 bg-slate-700 rounded-full mb-2 overflow-hidden border border-slate-600 relative shrink-0">
                   <div id="timer-bar" class="h-full bg-yellow-400 w-full timer-bar"></div>
               </div>
               <div id="message-box" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-1.5 mb-2 min-h-[30px] flex items-center justify-center text-center shadow-inner relative overflow-hidden shrink-0">
                   <span id="game-msg" class="text-slate-300 font-medium text-sm md:text-lg">Wild monster appeared!</span>
               </div>
               <div class="flex gap-2 mb-2 shrink-0">
                   <div class="flex-1 bg-white rounded-xl p-2 flex flex-col items-center justify-center shadow-md border-b-4 border-slate-300">
                        <div class="flex items-center gap-2 text-3xl md:text-4xl font-black text-slate-800">
                            <span id="num1">0</span><span class="text-blue-500">+</span><span id="num2">0</span><span class="text-slate-300">=</span>
                        </div>
                   </div>
                   <div id="answer-display" class="w-1/3 bg-slate-700 text-white border-2 border-slate-600 rounded-xl flex items-center justify-center text-3xl md:text-4xl font-bold shadow-inner truncate px-2">?</div>
               </div>
               <div class="grid grid-cols-3 gap-1 flex-1 min-h-0">
                   <button onclick="appendNumber(1)" class="numpad-btn">1</button><button onclick="appendNumber(2)" class="numpad-btn">2</button><button onclick="appendNumber(3)" class="numpad-btn">3</button>
                   <button onclick="appendNumber(4)" class="numpad-btn">4</button><button onclick="appendNumber(5)" class="numpad-btn">5</button><button onclick="appendNumber(6)" class="numpad-btn">6</button>
                   <button onclick="appendNumber(7)" class="numpad-btn">7</button><button onclick="appendNumber(8)" class="numpad-btn">8</button><button onclick="appendNumber(9)" class="numpad-btn">9</button>
                   <button onclick="clearInput()" class="numpad-btn bg-red-600 hover:bg-red-500 border-b-4 border-red-800">C</button>
                   <button onclick="appendNumber(0)" class="numpad-btn">0</button>
                   <button id="numpad-go" onclick="submitAnswer()" class="numpad-btn bg-green-600 hover:bg-green-500 border-b-4 border-green-800">GO</button>
               </div>
            </div>
        </div>
    </div>

    <!-- SCREEN 3: SUMMARY -->
    <div id="summary-screen" class="screen h-full w-full bg-slate-900 items-center justify-center px-4 pt-20 pb-4">
        <div class="bg-white border-4 border-yellow-400 rounded-3xl p-6 max-w-md w-full text-center shadow-2xl relative overflow-visible flex flex-col h-[75vh]">
            <div class="absolute -top-5 left-1/2 transform -translate-x-1/2 bg-blue-600 px-6 py-2 rounded-full border-4 border-white shadow-lg min-w-[200px] z-10">
                <h2 id="victory-title" class="text-lg md:text-xl font-black text-white uppercase tracking-widest">Time's Up!</h2>
            </div>
            <div class="mt-8 flex flex-col items-center justify-center mb-2 shrink-0">
                <img id="ending-img" src="Husky5.png" class="w-28 h-28 object-contain animate-bounce mb-3 drop-shadow-xl">
                <div class="flex flex-col items-center bg-yellow-50 border-4 border-yellow-400 rounded-2xl px-10 py-2 shadow-md transform -rotate-1">
                    <span class="text-[10px] font-bold text-yellow-600 uppercase tracking-widest mb-0.5">Final Score</span>
                    <span id="final-score" class="text-5xl font-black text-slate-800 leading-none">0</span>
                </div>
                <div id="time-bonus-display" class="mt-2 text-green-600 font-bold text-xs hidden bg-green-50 px-3 py-1 rounded-full border border-green-200">Time Bonus: +<span id="time-bonus-val">0</span></div>
            </div>
            <p id="victory-msg" class="text-lg mb-4 font-bold text-slate-700 shrink-0">Great training session!</p>
            
            <div class="w-full bg-slate-100 rounded-xl p-3 mb-4 border-2 border-slate-200 flex-1 min-h-0 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-2 shrink-0">
                     <h3 class="text-center font-bold text-slate-600 uppercase tracking-wide text-xs">üèÜ Leaderboard</h3>
                     <div id="status-indicator" class="text-[10px] text-slate-400 font-mono">Connecting...</div>
                </div>
                <div class="flex gap-2 mb-2 shrink-0" id="submit-score-area">
                    <input type="text" id="player-name-input" maxlength="10" placeholder="Your Name" class="flex-1 px-3 py-2 rounded-lg border-2 border-slate-300 text-center font-bold focus:outline-none focus:border-blue-500 text-base">
                    <button onclick="submitScore()" class="bg-blue-600 text-white font-bold px-3 py-2 rounded-lg shadow active:scale-95 transition-transform text-sm">Save</button>
                </div>
                <div id="leaderboard-list" class="space-y-2 overflow-y-auto pr-1 flex-1 text-left">
                    <div class="text-center text-slate-400 text-sm animate-pulse">Loading scores...</div>
                </div>
            </div>
            <button onclick="goToStartScreen()" class="w-full bg-green-500 hover:bg-green-400 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg border-b-4 border-green-700 flex items-center justify-center gap-2 active:translate-y-1 active:shadow-none shrink-0">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i> <span id="replay-btn-text">Battle Again</span>
            </button>
        </div>
    </div>

    <!-- FIREBASE LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let firebaseConfig;
        let appId = "husky-game";
        
        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = __app_id;
            const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            window.getDbCollection = (db) => collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            window.getInitialToken = () => initialToken;
        } else {
            // PRODUCTION
            firebaseConfig = {
              apiKey: "AIzaSyByPxGPOSCLA7slRhLGvy0KjP4OGY2gcBY",
              authDomain: "husky-calculation-battle.firebaseapp.com",
              projectId: "husky-calculation-battle",
              storageBucket: "husky-calculation-battle.firebasestorage.app",
              messagingSenderId: "236879314476",
              appId: "1:236879314476:web:a0d76031c6cd93c8a85b89",
              measurementId: "G-J823KXVD8T"
            };
            window.getDbCollection = (db) => collection(db, 'leaderboard');
            window.getInitialToken = () => null;
        }

        const statusEl = document.getElementById('status-indicator');

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            let currentUser = null;

            async function initAuth() {
                try {
                    const token = window.getInitialToken();
                    if (token) await signInWithCustomToken(auth, token);
                    else await signInAnonymously(auth);
                } catch (authErr) {
                    console.error("Auth failed:", authErr);
                    if(statusEl) { statusEl.innerText = "Auth Failed"; statusEl.classList.add('text-red-500'); }
                }
            }
            initAuth();

            onAuthStateChanged(auth, (user) => {
                currentUser = user;
                if(user) {
                    if(statusEl) { statusEl.innerText = "üü¢ Online"; statusEl.classList.add('text-green-500'); }
                    listenToLeaderboard(db);
                } else {
                    if(statusEl) statusEl.innerText = "üî¥ Offline";
                }
            });

            window.submitScore = async () => {
                if (!currentUser) { alert("Connecting to server..."); return; }
                const nameInput = document.getElementById('player-name-input');
                const name = nameInput.value.trim() || "Trainer";
                const finalScore = parseInt(document.getElementById('final-score').innerText);
                
                nameInput.disabled = true;
                try {
                    const colRef = window.getDbCollection(db);
                    await addDoc(colRef, { name: name, score: finalScore, timestamp: Date.now() });
                    document.getElementById('submit-score-area').style.display = 'none';
                } catch (e) {
                    console.error("Save Error", e);
                    alert("Could not save score. Check internet connection.");
                    nameInput.disabled = false;
                }
            };

            function listenToLeaderboard(db) {
                const colRef = window.getDbCollection(db);
                onSnapshot(colRef, (snapshot) => {
                    const scores = [];
                    snapshot.forEach(doc => scores.push(doc.data()));
                    scores.sort((a, b) => b.score - a.score);
                    renderLeaderboard(scores.slice(0, 5));
                }, (error) => {
                    console.error("DB Error", error);
                    document.getElementById('leaderboard-list').innerHTML = '<div class="text-red-400 text-sm">Connection Failed</div>';
                });
            }
        } catch (e) {
            console.error("Init Error", e);
            if(statusEl) statusEl.innerText = "Config Error";
        }

        function renderLeaderboard(scores) {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            if (scores.length === 0) { list.innerHTML = '<div class="text-center text-slate-400 text-sm">No scores yet. Be the first!</div>'; return; }
            scores.forEach((entry, index) => {
                const rank = index + 1;
                let rankHtml = '';
                if (index === 0) { rankHtml = `<div class="bg-yellow-100 text-yellow-600 p-1 rounded shadow-sm"><i data-lucide="crown" class="w-4 h-4 fill-current"></i></div>`; } 
                else if (index === 1) { rankHtml = `<div class="bg-slate-100 text-slate-500 p-1 rounded shadow-sm"><i data-lucide="medal" class="w-4 h-4 fill-current"></i></div>`; } 
                else if (index === 2) { rankHtml = `<div class="bg-orange-100 text-orange-600 p-1 rounded shadow-sm"><i data-lucide="medal" class="w-4 h-4 fill-current"></i></div>`; } 
                else { rankHtml = `<span class="rank font-bold text-base w-6 text-slate-400 text-center">${rank}</span>`; }
                const borderClass = index === 0 ? 'border-l-4 border-yellow-400' : (index === 1 ? 'border-l-4 border-slate-300' : (index === 2 ? 'border-l-4 border-orange-300' : ''));
                
                const item = document.createElement('div');
                item.className = `leaderboard-item flex justify-between items-center bg-white p-2 rounded shadow-sm text-xs md:text-sm ${borderClass}`;
                item.innerHTML = `
                    <div class="flex items-center gap-3 min-w-0">
                        ${rankHtml}
                        <span class="font-bold text-slate-700 truncate">${entry.name}</span>
                    </div>
                    <span class="font-mono font-bold text-blue-600 ml-2 shrink-0">${entry.score}</span>`;
                list.appendChild(item);
            });
            lucide.createIcons(); 
        }
    </script>

    <!-- GAME LOGIC -->
    <script>
        // Variables
        let currentLang = 'en';
        let score = 0;
        let level = 1;
        const EXP_NEEDED = 2; 
        const MAX_LEVEL = 5; 
        const GAME_DURATION = 90; 
        
        let playerHP = 100;
        let playerMaxHP = 100;
        let monsterHP = 0;
        let monsterMaxHP = 0;
        let monsterDamage = 5;
        
        let currentProblem = {};
        let currentInput = ""; 
        let isProcessing = false;
        let isGameActive = false;
        let isPaused = false;
        let isMuted = false;
        
        let globalTimerInterval;
        let globalTimeLeft = GAME_DURATION;
        let questionTimerInterval;
        let questionTimeLeft = 100;
        
        let idleInterval = null;
        let isIdleFrame1 = true;
        let idleSpeed = 500;

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let bgmInterval = null;
        let bgmNoteIndex = 0;

        // Translations
        const i18n = {
            en: {
                title: "Husky Calculation Battle",
                subtitle: "Help Husky defeat wild monsters!",
                instrTitle: "How to Play",
                instrList: [ "Type answer using keypad.", "Game Time: <strong>90s</strong>. Max Level: <strong>5</strong>.", "Correct answers deal damage.", "Defeat a monster to <strong>Level Up</strong> & heal!", "<strong>Warning:</strong> Monster attacks back!" ],
                startBtn: "Start Adventure",
                monsterName: "Monster", bossName: "BOSS", gameMsg: "Wild monster appeared!",
                monsterDefeated: "Defeated!", score: "Score", level: "Level",
                victoryTitle: "Victory!", defeatTitle: "Good Try!", timeUpTitle: "Time's Up!",
                victoryMsg: "Boss Defeated! Amazing!", defeatMsg: "You did your best!", timeUpMsg: "Good Effort!",
                replayBtn: "Play Again", correct: "Correct!", wrong: "Missed!", monsterAttack: "Attack!",
                langBtn: "‰∏≠Êñá", levelup: "Level Up!", confirm: "GO"
            },
            zh: {
                title: "ÂìàÂ£´Â•áÊï∏ÁÆóÂ§ßÊà∞",
                subtitle: "Âπ´Âä©ÂìàÂ£´Â•áÊâìÊïóÈáéÁîüÊÄ™Áâ©ÔºÅ",
                instrTitle: "ÈÅäÊà≤Ë™™Êòé",
                instrList: [ "‰ΩøÁî®ÈçµÁõ§Ëº∏ÂÖ•Á≠îÊ°à„ÄÇ", "ÈÅäÊà≤ÊôÇÈñìÔºö<strong>90Áßí</strong>„ÄÇÊúÄÈ´òÁ≠âÁ¥öÔºö<strong>5</strong>„ÄÇ", "Á≠îÂ∞çÂïèÈ°åÈÄ†ÊàêÂÇ∑ÂÆ≥„ÄÇ", "ÊâìÊïóÊÄ™Áâ©ÂèØ<strong>ÂçáÁ¥ö</strong>‰∏¶ÂõûË°ÄÔºÅ", "<strong>Ê≥®ÊÑèÔºö</strong> ÊÄ™Áâ©ÊúÉÂèçÊìäÔºÅ" ],
                startBtn: "ÈñãÂßãÂÜíÈö™",
                monsterName: "ÊÄ™Áâ©", bossName: "È¶ñÈ†ò", gameMsg: "ÊÄ™Áâ©Âá∫Áèæ‰∫ÜÔºÅ",
                monsterDefeated: "ÂãùÂà©ÔºÅ", score: "ÂàÜÊï∏", level: "Á≠âÁ¥ö",
                victoryTitle: "ÂãùÂà©ÔºÅ", defeatTitle: "ÂÜçÊé•ÂÜçÂé≤!", timeUpTitle: "ÊôÇÈñìÂà∞ÔºÅ",
                victoryMsg: "È¶ñÈ†òË¢´ÊâìÊïó‰∫ÜÔºÅÂ§™Ê£í‰∫ÜÔºÅ", defeatMsg: "‰Ω†Â∑≤Á∂ìÂæàÊ£í‰∫ÜÔºÅ", timeUpMsg: "ÂæàÊ£íÁöÑÂä™ÂäõÔºÅ",
                replayBtn: "ÂõûÂà∞È¶ñÈ†Å", correct: "Á≠îÂ∞ç‰∫ÜÔºÅ", wrong: "ÈåØÈÅé‰∫ÜÔºÅ", monsterAttack: "ÂèçÊìäÔºÅ",
                langBtn: "English", levelup: "ÂçáÁ¥öÔºÅ", confirm: "Ëµ∞"
            }
        };

        // Game Functions
        function appendNumber(num) { if(isProcessing || !isGameActive || isPaused || currentInput.length >= 3) return; currentInput += num; updateAnswerDisplay(); }
        function clearInput() { if(isProcessing || !isGameActive || isPaused) return; currentInput = ""; updateAnswerDisplay(); }
        function updateAnswerDisplay() { const display = document.getElementById('answer-display'); display.innerText = currentInput === "" ? "?" : currentInput; if(currentInput !== "") display.classList.add('text-yellow-400'); else display.classList.remove('text-yellow-400'); }

        const BGM_NOTES = [261.63, 329.63, 392.00, 523.25]; 
        function toggleMute() { isMuted = !isMuted; const icon = document.getElementById('mute-icon'); if(isMuted) { stopBGM(); icon.setAttribute('data-lucide', 'volume-x'); icon.classList.add('text-red-400'); } else { if(isGameActive && !isPaused) startBGM(); icon.setAttribute('data-lucide', 'volume-2'); icon.classList.remove('text-red-400'); } lucide.createIcons(); }
        function startBGM() { if(isMuted) return; stopBGM(); bgmNoteIndex = 0; const tempo = Math.max(150, 500 - ((level - 1) * 80)); bgmInterval = setInterval(() => { if(isPaused || isMuted) return; const freq = BGM_NOTES[bgmNoteIndex % BGM_NOTES.length]; playTone(freq, 'triangle', 0.1); if(bgmNoteIndex % 4 === 0) playTone(130.81, 'square', 0.2); bgmNoteIndex++; }, tempo); }
        function stopBGM() { if (bgmInterval) clearInterval(bgmInterval); bgmInterval = null; }
        function playTone(freq, type, duration) { if (isMuted) return; if (audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gainNode = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration); osc.connect(gainNode); gainNode.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration); }
        function playCorrectSound() { playTone(600, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.2), 100); }
        function playWrongSound() { playTone(150, 'sawtooth', 0.3); }
        function playLevelUpSound() { playTone(523.25, 'square', 0.1); setTimeout(() => playTone(659.25, 'square', 0.1), 100); setTimeout(() => playTone(783.99, 'square', 0.1), 200); setTimeout(() => playTone(1046.50, 'square', 0.4), 300); }
        function playGameOverSound() { playTone(300, 'triangle', 0.3); setTimeout(() => playTone(200, 'triangle', 0.3), 200); setTimeout(() => playTone(100, 'triangle', 0.6), 400); }
        function playHitSound() { playTone(100, 'sawtooth', 0.1); }

        function toggleLanguage() { currentLang = currentLang === 'en' ? 'zh' : 'en'; updateLanguage(); }
        function updateLanguage() {
            const t = i18n[currentLang];
            document.querySelectorAll('.lang-btn-text').forEach(el => el.innerText = t.langBtn);
            document.getElementById('title-text').innerText = t.title;
            document.getElementById('instr-title').innerHTML = `<i data-lucide="info" class="w-4 h-4"></i> ${t.instrTitle}`;
            const listEl = document.getElementById('instr-list'); listEl.innerHTML = '';
            t.instrList.forEach(item => { const li = document.createElement('li'); li.innerHTML = item; listEl.appendChild(li); });
            lucide.createIcons();
            document.getElementById('start-btn-text').innerText = t.startBtn;
            const enemyNameEl = document.getElementById('enemy-name'); if(enemyNameEl) enemyNameEl.innerText = level === MAX_LEVEL ? t.bossName : t.monsterName;
            if(!isProcessing && isGameActive) document.getElementById('game-msg').innerText = t.gameMsg;
            const goBtn = document.getElementById('numpad-go'); if(goBtn) goBtn.innerText = t.confirm;
            const inputEl = document.getElementById('answer-input'); if(inputEl) inputEl.placeholder = t.placeholder;
            const scoreLabel = document.getElementById('score-label'); if(scoreLabel) scoreLabel.innerText = t.score;
            const levelLabel = document.getElementById('level-label'); if(levelLabel) levelLabel.innerText = t.level;
            document.getElementById('victory-msg').innerText = t.victoryMsg;
            document.getElementById('replay-btn-text').innerText = t.replayBtn;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            const timerContainer = document.getElementById('global-timer-container');
            if (screenId === 'game-screen') timerContainer.classList.remove('hidden'); else timerContainer.classList.add('hidden');
        }

        function goToStartScreen() { stopIdleAnimation(); stopBGM(); showScreen('start-screen'); document.getElementById('game-screen').classList.remove('time-up-effect'); }
        function startGame() { if (audioCtx.state === 'suspended') audioCtx.resume(); score = 0; level = 1; globalTimeLeft = GAME_DURATION; isGameActive = true; isPaused = false; currentInput = ""; updateAnswerDisplay(); playerMaxHP = 100; playerHP = playerMaxHP; monsterHP = 0; document.getElementById('game-screen').classList.remove('time-up-effect'); updateHUD(); updatePlayerHP(); showScreen('game-screen'); updateLanguage(); startGlobalTimer(); startIdleAnimation(); startBGM(); generateProblem(); }
        function startIdleAnimation() { if (idleInterval) clearInterval(idleInterval); const playerSprite = document.getElementById('player-sprite'); isIdleFrame1 = true; playerSprite.src = 'Husky1.png'; idleSpeed = Math.max(150, 500 - ((level - 1) * 80)); idleInterval = setInterval(() => { if(isPaused) return; isIdleFrame1 = !isIdleFrame1; playerSprite.src = isIdleFrame1 ? 'Husky1.png' : 'Husky2.png'; }, idleSpeed); }
        function stopIdleAnimation() { if (idleInterval) { clearInterval(idleInterval); idleInterval = null; } }

        function spawnMonster() {
            const isBoss = level === MAX_LEVEL;
            let hp = 0; let dmg = 0;
            switch(level) { case 1: hp = 40; dmg = 5; break; case 2: hp = 80; dmg = 6; break; case 3: hp = 120; dmg = 8; break; case 4: hp = 150; dmg = 10; break; case 5: hp = 250; dmg = 12; break; default: hp = 40; dmg = 5; }
            monsterMaxHP = hp; monsterHP = hp; monsterDamage = dmg;
            
            if (isBoss) {
                document.getElementById('boss-badge').classList.remove('hidden'); document.getElementById('enemy-sprite').classList.add('boss-sprite');
                document.getElementById('enemy-name').innerText = i18n[currentLang].bossName; document.getElementById('enemy-name').classList.add('text-red-500');
                document.getElementById('game-msg').innerHTML = `<span class="text-red-500 font-bold animate-pulse">BOSS BATTLE!</span>`;
            } else {
                document.getElementById('boss-badge').classList.add('hidden'); document.getElementById('enemy-sprite').classList.remove('boss-sprite');
                document.getElementById('enemy-name').innerText = i18n[currentLang].monsterName; document.getElementById('enemy-name').classList.remove('text-red-500');
                document.getElementById('game-msg').innerText = i18n[currentLang].gameMsg; document.getElementById('game-msg').className = "text-slate-300 font-medium text-sm md:text-lg";
            }
            let enemyId = Math.floor(Math.random() * 10) + 1; document.getElementById('enemy-sprite').src = `monster${enemyId}.png`; document.getElementById('enemy-sprite').classList.remove('opacity-0', 'grayscale', 'scale-90', 'blur-sm');
            updateMonsterHUD();
        }

        function updateMonsterHUD() {
            document.getElementById('enemy-hp-text').innerText = `${Math.ceil(monsterHP)}/${Math.ceil(monsterMaxHP)}`;
            document.getElementById('enemy-atk-text').innerText = monsterDamage;
            const hpPercent = (monsterHP / monsterMaxHP) * 100; const bar = document.getElementById('enemy-hp-bar'); bar.style.width = `${hpPercent}%`;
            if(hpPercent < 30) bar.className = 'h-full bg-red-500 w-full transition-all duration-500'; else if (hpPercent < 60) bar.className = 'h-full bg-yellow-400 w-full transition-all duration-500'; else bar.className = 'h-full bg-green-500 w-full transition-all duration-500';
        }
        function updatePlayerHP() {
            const hpPercent = (playerHP / playerMaxHP) * 100; const bar = document.getElementById('player-hp-bar'); bar.style.width = `${Math.max(0, hpPercent)}%`; document.getElementById('player-hp-text').innerText = `${Math.ceil(playerHP)}/${playerMaxHP}`;
            if(hpPercent < 30) { bar.classList.remove('bg-green-500'); bar.classList.add('bg-red-500'); document.getElementById('game-screen').classList.add('low-health'); } else { bar.classList.add('bg-green-500'); bar.classList.remove('bg-red-500'); document.getElementById('game-screen').classList.remove('low-health'); }
        }
        function updateHUD() { document.getElementById('score-display').innerText = score; document.getElementById('level-text').innerText = level; }
        
        // UPDATED: Trigger attack if time bar runs out
        function handleBonusTimeUp() {
             clearInterval(questionTimerInterval);
             triggerMonsterAttack();
        }

        function handleTimeUp() { isGameActive = false; clearInterval(globalTimerInterval); clearInterval(questionTimerInterval); stopBGM(); const battleScene = document.getElementById('game-screen'); battleScene.classList.add('time-up-effect'); battleScene.classList.add('animate-shake'); playWrongSound(); setTimeout(() => { battleScene.classList.remove('animate-shake'); endGame('timeup'); }, 1500); }
        function startGlobalTimer() { clearInterval(globalTimerInterval); document.getElementById('global-time-display').innerText = globalTimeLeft; globalTimerInterval = setInterval(() => { if(isPaused) return; globalTimeLeft--; document.getElementById('global-time-display').innerText = globalTimeLeft; if (globalTimeLeft <= 10) { document.getElementById('global-time-display').classList.add('text-red-500', 'animate-pulse'); playTone(800, 'sine', 0.05); } if (globalTimeLeft <= 0) handleTimeUp(); }, 1000); }
        
        function generateProblem() {
            if (!isGameActive) return; isProcessing = false; if (monsterHP <= 0) spawnMonster();
            const num1 = Math.floor(Math.random() * 11); const num2 = Math.floor(Math.random() * (20 - num1 + 1)); const ans = num1 + num2; currentProblem = { num1, num2, ans };
            document.getElementById('num1').innerText = num1; document.getElementById('num2').innerText = num2; currentInput = ""; updateAnswerDisplay();
            startQuestionTimer();
        }

        function startQuestionTimer() {
            clearInterval(questionTimerInterval); questionTimeLeft = 100; const bar = document.getElementById('timer-bar'); bar.style.width = '100%';
            
            // Adjusted Speeds: Slower to give kids more time
            let speedMs = 100;
            switch(level) {
                case 1: speedMs = 100; break; // 10s
                case 2: speedMs = 82; break;  // ~8.2s
                case 3: speedMs = 65; break;  // 6.5s
                case 4: speedMs = 48; break;  // ~4.8s
                case 5: speedMs = 30; break;  // 3s (Boss)
            }
            
            questionTimerInterval = setInterval(() => { 
                if(isPaused) return; 
                questionTimeLeft -= 1; 
                bar.style.width = `${questionTimeLeft}%`; 
                if(questionTimeLeft < 30) bar.classList.replace('bg-yellow-400', 'bg-red-500'); 
                // NEW LOGIC: Trigger attack when time runs out
                if (questionTimeLeft <= 0) handleBonusTimeUp(); 
            }, speedMs);
        }

        function showLevelUpScene() { isPaused = true; const overlay = document.getElementById('levelup-overlay'); overlay.classList.remove('hidden'); playLevelUpSound(); startIdleAnimation(); startBGM(); setTimeout(() => { overlay.classList.add('hidden'); isPaused = false; }, 2000); }

        function showVictoryScene() {
            isPaused = true;
            const overlay = document.getElementById('victory-overlay');
            overlay.classList.remove('hidden');
            
            playLevelUpSound(); 
            setTimeout(() => playCorrectSound(), 500);
            setTimeout(() => playCorrectSound(), 1000);
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                endGame('victory'); 
            }, 4000); 
        }

        function submitAnswer() {
            if(isProcessing || !isGameActive || isPaused) return;
            const inputVal = parseInt(currentInput); if(isNaN(inputVal)) return;
            isProcessing = true; clearInterval(questionTimerInterval);
            const isCorrect = inputVal === currentProblem.ans; const t = i18n[currentLang];

            if(isCorrect) {
                playCorrectSound(); document.getElementById('game-msg').innerHTML = `<span class="text-green-400 font-bold animate-pulse">${t.correct}</span>`;
                const playerContainer = document.getElementById('player-container'); const attackEffect = document.getElementById('attack-effect'); const enemySprite = document.getElementById('enemy-sprite');
                stopIdleAnimation(); document.getElementById('player-sprite').src = 'Husky3.png'; playerContainer.classList.add('translate-x-8', '-translate-y-4'); attackEffect.classList.remove('hidden');

                const levelBase = 10 + (level * 5); const timeBonus = Math.max(0, Math.floor(questionTimeLeft / 5)); const damage = levelBase + timeBonus;
                score += damage; monsterHP -= damage; if (monsterHP < 0) monsterHP = 0; updateMonsterHUD(); updateHUD();

                if (monsterHP <= 0) {
                    const isBossKill = (level === MAX_LEVEL);
                    if (level < MAX_LEVEL) { level++; showLevelUpScene(); } updateHUD();

                    setTimeout(() => {
                        enemySprite.classList.add('opacity-0', 'grayscale', 'scale-90', 'blur-sm'); document.getElementById('game-msg').innerHTML = `<span class="text-yellow-400 font-bold">${t.monsterDefeated}</span>`;
                        const regen = 20; playerHP = Math.min(playerMaxHP, playerHP + regen); updatePlayerHP();
                        if (isBossKill) { 
                             const bossTimeBonus = globalTimeLeft * 10;
                             score += bossTimeBonus;
                             showVictoryScene(); 
                             return;
                        }
                        setTimeout(() => { cleanupAttackAnim(); generateProblem(); }, 1500);
                    }, 300);
                } else {
                     setTimeout(() => { enemySprite.classList.add('animate-damage'); }, 100); setTimeout(() => { enemySprite.classList.remove('animate-damage'); }, 500);
                     setTimeout(() => { cleanupAttackAnim(); triggerMonsterAttack(); }, 1000);
                }
            } else {
                playWrongSound(); document.getElementById('game-msg').innerHTML = `<span class="text-red-400 font-bold text-sm">${t.wrong} ${currentProblem.num1}+${currentProblem.num2}=${currentProblem.ans}</span>`;
                setTimeout(() => { triggerMonsterAttack(); }, 2000);
            }
        }
        
        function cleanupAttackAnim() { const playerContainer = document.getElementById('player-container'); const attackEffect = document.getElementById('attack-effect'); playerContainer.classList.remove('translate-x-8', '-translate-y-4'); attackEffect.classList.add('hidden'); startIdleAnimation(); }

        function triggerMonsterAttack() {
            if(!isGameActive || monsterHP <= 0) { if(isGameActive) generateProblem(); return; }
            const t = i18n[currentLang]; document.getElementById('game-msg').innerHTML = `<span class="text-red-500 font-bold">${t.monsterAttack}</span>`;
            const enemyContainer = document.getElementById('enemy-container'); const monsterAttackEffect = document.getElementById('monster-attack-effect'); const playerSprite = document.getElementById('player-sprite');
            enemyContainer.classList.add('-translate-x-8', 'translate-y-4'); monsterAttackEffect.classList.remove('hidden');
            
            setTimeout(() => {
                playHitSound(); playerSprite.classList.add('animate-hit');
                playerHP -= monsterDamage; if(playerHP < 0) playerHP = 0; updatePlayerHP();
                setTimeout(() => {
                    enemyContainer.classList.remove('-translate-x-8', 'translate-y-4'); monsterAttackEffect.classList.add('hidden'); playerSprite.classList.remove('animate-hit');
                    if (playerHP <= 0) endGame('defeat'); else generateProblem();
                }, 500);
            }, 300);
        }

        function endGame(reason) {
            playGameOverSound(); stopBGM(); isGameActive = false; stopIdleAnimation(); clearInterval(globalTimerInterval); clearInterval(questionTimerInterval);
            const t = i18n[currentLang];
            const titleEl = document.getElementById('victory-title'); const msgEl = document.getElementById('victory-msg'); const imgEl = document.getElementById('ending-img'); const bonusEl = document.getElementById('time-bonus-display'); const bonusVal = document.getElementById('time-bonus-val');
            document.getElementById('submit-score-area').style.display = 'flex'; document.getElementById('player-name-input').disabled = false;
            
            if (reason === 'victory') {
                titleEl.innerText = t.victoryTitle; msgEl.innerText = t.victoryMsg; imgEl.src = "Husky5.png"; bonusEl.classList.remove('hidden'); bonusVal.innerText = globalTimeLeft * 10;
            } else if (reason === 'defeat') {
                titleEl.innerText = t.defeatTitle; msgEl.innerText = t.defeatMsg; imgEl.src = "Husky7.png"; bonusEl.classList.add('hidden');
            } else {
                titleEl.innerText = reason === 'timeup' ? t.timeUpTitle : t.defeatTitle; msgEl.innerText = reason === 'timeup' ? t.timeUpMsg : t.defeatMsg; imgEl.src = "Husky7.png"; bonusEl.classList.add('hidden');
            }
            document.getElementById('final-score').innerText = score; showScreen('summary-screen');
        }

        document.addEventListener('keydown', (e) => {
            if (document.getElementById('game-screen').classList.contains('active')) {
                if (e.key >= '0' && e.key <= '9') appendNumber(parseInt(e.key));
                else if (e.key === 'Backspace') { if(currentInput.length > 0) { currentInput = currentInput.slice(0, -1); updateAnswerDisplay(); } }
                else if (e.key === 'Enter') submitAnswer();
                else if (e.key === 'Escape') clearInput();
            }
        });
        
        updateLanguage();
        lucide.createIcons();

    </script>
</body>
</html>
