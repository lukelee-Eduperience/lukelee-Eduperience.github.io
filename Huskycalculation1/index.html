<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Husky Calculation Battle</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style type="text/tailwindcss">
        /* Custom Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
        @keyframes damage-flash {
            0%, 100% { opacity: 1; filter: none; }
            50% { opacity: 0.5; filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
        }
        @keyframes hit-flash-red {
            0%, 100% { filter: none; }
            50% { filter: drop-shadow(0 0 10px red) sepia(1) hue-rotate(-50deg) saturate(5); }
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes pop-in {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.2) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        @keyframes rays {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        .animate-damage { animation: damage-flash 0.2s ease-in-out 2; }
        .animate-hit { animation: hit-flash-red 0.3s ease-in-out; }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
        .animate-spin-slow { animation: spin-slow 4s linear infinite; }
        .animate-pop-in { animation: pop-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .animate-rays { animation: rays 10s linear infinite; }
        
        .pixelated { image-rendering: pixelated; }

        /* Screen visibility toggles */
        .screen { display: none; }
        .screen.active { display: flex; }
        
        /* Timer Bar Animation */
        .timer-bar { transition: width 0.1s linear; }

        /* Level Up Overlay */
        .levelup-text {
            text-shadow: 4px 4px 0px #000, -2px -2px 0px #000;
        }

        /* Numpad Button Styles */
        .numpad-btn {
            @apply bg-slate-700 text-white font-bold rounded-lg shadow-md active:bg-slate-600 active:scale-95 transition-transform flex items-center justify-center text-xl select-none;
            height: 44px; /* Reduced slightly for mobile fit */
        }
    </style>
</head>
<!-- Use h-[100dvh] for mobile browser compatibility -->
<body class="font-sans overflow-hidden bg-slate-900 text-slate-800 touch-manipulation h-[100dvh]">

    <!-- Global Game Timer Display (Fixed Top Center - Visible in Game) -->
    <div id="global-timer-container" class="fixed top-2 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="bg-slate-800/90 text-white border-2 border-yellow-400 px-4 py-1 rounded-2xl font-mono text-xl font-bold shadow-2xl flex items-center gap-2">
            <i data-lucide="clock" class="w-4 h-4 text-yellow-400"></i>
            <span id="global-time-display">60</span>
        </div>
    </div>

    <!-- LEVEL UP OVERLAY SCENE -->
    <div id="levelup-overlay" class="fixed inset-0 z-[60] bg-black/80 hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <!-- Rotating Sunburst Background -->
        <div class="absolute inset-0 flex items-center justify-center overflow-hidden z-0">
            <div class="w-[200vmax] h-[200vmax] bg-[conic-gradient(from_0deg,transparent_0_20deg,#fbbf24_20deg_40deg,transparent_40deg_60deg,#fbbf24_60deg_80deg,transparent_80deg_100deg,#fbbf24_100deg_120deg,transparent_120deg_140deg,#fbbf24_140deg_160deg,transparent_160deg_180deg,#fbbf24_180deg_200deg,transparent_200deg_220deg,#fbbf24_220deg_240deg,transparent_240deg_260deg,#fbbf24_260deg_280deg,transparent_280deg_300deg,#fbbf24_300deg_320deg,transparent_320deg_340deg,#fbbf24_340deg_360deg)] opacity-20 animate-rays"></div>
        </div>
        
        <div class="relative z-10 flex flex-col items-center animate-pop-in">
            <h1 class="text-6xl md:text-8xl font-black text-yellow-400 levelup-text mb-8 transform -rotate-6 tracking-wider text-center">
                LEVEL UP!
            </h1>
            <img src="Husky6.png" class="w-48 h-48 md:w-64 md:h-64 object-contain drop-shadow-[0_0_30px_rgba(250,204,21,0.8)] animate-bounce">
            <div class="mt-8 text-white text-xl md:text-2xl font-bold bg-slate-800/80 px-6 py-2 rounded-full border-2 border-yellow-400">
                Speed Up!
            </div>
        </div>
    </div>

    <!-- SCREEN 1: START MENU -->
    <div id="start-screen" class="screen active h-full w-full bg-red-600 items-center justify-center p-4 relative overflow-hidden">
        <!-- Start Screen Language Button -->
        <button onclick="toggleLanguage()" class="absolute top-4 right-4 z-50 bg-white/20 backdrop-blur-md border border-white/40 text-white font-bold py-2 px-4 rounded-full hover:bg-white/30 transition-all flex items-center gap-2 shadow-lg">
            <i data-lucide="globe" class="w-4 h-4"></i>
            <span class="lang-btn-text">中文</span>
        </button>

        <div class="absolute inset-0 bg-gradient-to-br from-red-500 to-red-700"></div>
        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full transform translate-x-1/2 -translate-y-1/2"></div>
        
        <div class="bg-white/95 backdrop-blur-md border-4 border-slate-800 rounded-3xl p-6 max-w-md w-full text-center shadow-2xl relative z-10 max-h-[90dvh] overflow-y-auto">
            <div class="flex justify-center mb-2 mt-2">
                 <!-- Start Screen Husky (Husky4.png) -->
                 <img src="Husky4.png" class="w-32 h-32 md:w-40 md:h-40 object-contain animate-bounce drop-shadow-2xl">
            </div>
            
            <h1 id="title-text" class="text-2xl md:text-3xl font-extrabold mb-2 text-slate-800 tracking-tight">Husky Calculation Battle</h1>
            
            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-3 mb-6 text-left shadow-sm">
                <h3 id="instr-title" class="font-bold text-yellow-800 mb-2 flex items-center gap-2 text-sm">
                    <i data-lucide="info" class="w-4 h-4"></i> How to Play
                </h3>
                <ul id="instr-list" class="text-xs md:text-sm text-yellow-900 space-y-1 list-disc list-inside font-medium">
                    <li>Type answer using keypad.</li>
                    <li>Game Time: <strong>60s</strong>. Max Level: <strong>5</strong>.</li>
                    <li>Correct answers deal damage.</li>
                    <li>Defeat a monster to <strong>Level Up</strong> & heal!</li>
                    <li><strong>Warning:</strong> Monster attacks back!</li>
                </ul>
            </div>
            
            <button onclick="startGame()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 md:py-4 px-8 rounded-xl text-lg md:text-xl transition-all transform hover:scale-105 shadow-lg border-b-4 border-blue-800 flex items-center justify-center gap-3 active:translate-y-1 active:shadow-none">
                <i data-lucide="play" class="w-5 h-5 md:w-6 md:h-6 fill-current"></i> <span id="start-btn-text">Start Adventure</span>
            </button>
        </div>
    </div>

    <!-- SCREEN 2: GAMEPLAY -->
    <div id="game-screen" class="screen h-[100dvh] w-full bg-slate-800 flex-col items-center relative overflow-hidden">
        
        <!-- Battle Scene (Reduced height slightly for mobile clearance) -->
        <div class="w-full h-[30vh] md:h-[45vh] relative bg-gradient-to-b from-blue-300 to-green-300 flex justify-center overflow-hidden border-b-4 border-slate-900 shrink-0">
             <div class="absolute bottom-0 w-full h-12 bg-green-600 skew-y-1 transform origin-bottom-right opacity-80"></div>
             <div class="absolute bottom-4 w-full h-12 bg-green-500 -skew-y-2 transform origin-bottom-left"></div>
             
             <div class="w-full max-w-4xl relative h-full">
                <!-- Player (Husky) - Bottom Left -->
                <div id="player-container" class="absolute bottom-0 left-2 z-20 transition-all duration-300">
                    <div class="relative group">
                        <!-- Attack Effect -->
                        <div id="attack-effect" class="hidden absolute top-0 -right-10 z-30 animate-ping">
                           <i data-lucide="zap" class="text-yellow-400 fill-yellow-400 w-12 h-12 md:w-16 md:h-16 drop-shadow-lg"></i>
                        </div>
                        
                        <!-- Sprite -->
                        <img id="player-sprite" src="Husky1.png" class="w-24 md:w-48 h-auto object-contain drop-shadow-xl">
                        
                        <!-- Player Stats - Right of Husky -->
                        <div class="absolute left-[100%] top-1/2 transform -translate-y-1/2 bg-white/90 text-slate-800 p-1.5 rounded-lg border-2 border-slate-600 shadow-lg text-[10px] md:text-xs font-bold min-w-[90px] md:min-w-[120px] ml-1">
                            <div class="mb-0.5 md:mb-1 font-black text-slate-900">Husky</div>
                            
                            <!-- HP Bar -->
                            <div class="flex justify-between items-center mb-0.5">
                                <span class="text-slate-500 mr-1">HP</span>
                                <span id="player-hp-text">100</span>
                            </div>
                            <div class="w-full h-1.5 md:h-2 bg-slate-200 rounded-full border border-slate-300 overflow-hidden mb-0.5">
                                <div id="player-hp-bar" class="h-full bg-green-500 w-full transition-all duration-300"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enemy - Upper Right -->
                <div id="enemy-container" class="absolute top-4 right-2 z-10 transition-all duration-500">
                     <div class="relative">
                        <!-- Monster Attack Effect -->
                        <div id="monster-attack-effect" class="hidden absolute bottom-0 -left-10 z-30 animate-ping">
                           <i data-lucide="swords" class="text-red-500 fill-red-500 w-12 h-12 md:w-16 md:h-16 drop-shadow-lg"></i>
                        </div>

                        <!-- Sprite (Custom Monster) -->
                        <img id="enemy-sprite" src="" class="w-24 h-24 md:w-32 md:h-32 md:w-48 md:h-48 object-contain pixelated animate-float">
                        
                        <!-- Enemy Stats - Left of Enemy -->
                        <div class="absolute right-[100%] top-1/2 transform -translate-y-1/2 bg-white/90 p-1.5 rounded-lg border-2 border-slate-700 shadow-lg text-[10px] md:text-xs font-bold min-w-[90px] md:min-w-[130px] mr-1">
                            <div class="flex justify-between mb-0.5 md:mb-1"><span id="enemy-name" class="font-black text-slate-900">Monster</span></div>
                            <div class="flex justify-between items-center mb-0.5">
                                <span class="text-slate-500 mr-1">HP</span>
                                <span id="enemy-hp-text"></span>
                            </div>
                            <div class="w-full h-1.5 md:h-2 bg-slate-200 rounded-full border border-slate-300 overflow-hidden">
                                <div id="enemy-hp-bar" class="h-full bg-green-500 w-full transition-all duration-500"></div>
                            </div>
                        </div>
                     </div>
                </div>
             </div>
        </div>

        <!-- Controls (Bottom Half) -->
        <div class="flex-1 w-full bg-slate-800 flex flex-col items-center justify-start relative z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.5)] border-t border-slate-700">
            <div class="w-full max-w-lg p-2 h-full flex flex-col pb-8"> <!-- Added pb-8 for mobile safe area -->
               
               <!-- Compact Stats HUD -->
               <div class="flex items-center justify-between gap-2 mb-2 bg-slate-700/50 p-1.5 rounded-xl border border-slate-600 shrink-0">
                    <!-- Left: Restart -->
                    <button onclick="endGame()" class="bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 text-red-300 p-2 rounded-lg transition-all" title="Restart">
                        <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                    </button>

                    <!-- Middle: Score & Level -->
                    <div class="flex-1 flex items-center justify-center gap-2 md:gap-4">
                        <div class="flex flex-col items-center justify-center bg-slate-800/50 rounded-lg px-2 md:px-4 py-1 min-w-[60px]">
                            <div id="score-label" class="text-[8px] md:text-[9px] font-bold text-slate-400 uppercase leading-none mb-0.5">Score</div>
                            <div id="score-display" class="text-lg md:text-xl font-black text-white leading-none">0</div>
                        </div>
                        <div class="flex flex-col items-center justify-center bg-slate-800/50 rounded-lg px-2 md:px-4 py-1 min-w-[60px]">
                            <div id="level-label" class="text-[8px] md:text-[9px] font-bold text-slate-400 uppercase leading-none mb-0.5">Level</div>
                            <div id="level-text" class="text-lg md:text-xl font-black text-white leading-none">1</div>
                        </div>
                    </div>

                    <!-- Right: Language -->
                    <button onclick="toggleLanguage()" class="bg-slate-600 hover:bg-slate-500 border border-slate-500 text-slate-300 p-2 rounded-lg transition-all" title="Language">
                        <i data-lucide="globe" class="w-4 h-4"></i>
                    </button>
               </div>
                
               <!-- Speed Bonus Bar -->
               <div class="w-full h-3 bg-slate-700 rounded-full mb-2 overflow-hidden border border-slate-600 relative shrink-0">
                   <div id="timer-bar" class="h-full bg-yellow-400 w-full timer-bar"></div>
               </div>

               <!-- Message Box -->
               <div id="message-box" class="bg-slate-900 border-2 border-slate-600 rounded-lg p-1.5 mb-2 min-h-[30px] flex items-center justify-center text-center shadow-inner relative overflow-hidden shrink-0">
                   <span id="game-msg" class="text-slate-300 font-medium text-sm md:text-lg">Wild monster appeared!</span>
               </div>

               <!-- Math Problem & Answer Area (Combined Row) -->
               <div class="flex gap-2 mb-2 shrink-0">
                   <!-- Problem -->
                   <div class="flex-1 bg-white rounded-xl p-2 flex items-center justify-center gap-2 text-3xl md:text-4xl font-black text-slate-800 shadow-md border-b-4 border-slate-300">
                      <span id="num1">0</span>
                      <span class="text-blue-500">+</span>
                      <span id="num2">0</span>
                      <span class="text-slate-300">=</span>
                   </div>
                   <!-- Answer Display -->
                   <div id="answer-display" class="w-1/3 bg-slate-700 text-white border-2 border-slate-600 rounded-xl flex items-center justify-center text-3xl md:text-4xl font-bold shadow-inner truncate px-2">
                       ?
                   </div>
               </div>

               <!-- Custom Numpad (Takes remaining space) -->
               <div class="grid grid-cols-3 gap-1 flex-1 min-h-0"> <!-- Reduced gap to 1 -->
                   <button onclick="appendNumber(1)" class="numpad-btn">1</button>
                   <button onclick="appendNumber(2)" class="numpad-btn">2</button>
                   <button onclick="appendNumber(3)" class="numpad-btn">3</button>
                   <button onclick="appendNumber(4)" class="numpad-btn">4</button>
                   <button onclick="appendNumber(5)" class="numpad-btn">5</button>
                   <button onclick="appendNumber(6)" class="numpad-btn">6</button>
                   <button onclick="appendNumber(7)" class="numpad-btn">7</button>
                   <button onclick="appendNumber(8)" class="numpad-btn">8</button>
                   <button onclick="appendNumber(9)" class="numpad-btn">9</button>
                   <button onclick="clearInput()" class="numpad-btn bg-red-600 hover:bg-red-500 border-b-4 border-red-800">C</button>
                   <button onclick="appendNumber(0)" class="numpad-btn">0</button>
                   <button onclick="submitAnswer()" class="numpad-btn bg-green-600 hover:bg-green-500 border-b-4 border-green-800">GO</button>
               </div>
            </div>
        </div>
    </div>

    <!-- SCREEN 3: SUMMARY -->
    <div id="summary-screen" class="screen h-full w-full bg-slate-900 items-center justify-center p-4">
        <div class="bg-white border-4 border-yellow-400 rounded-3xl p-8 max-w-md w-full text-center shadow-2xl relative">
            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-blue-600 px-8 py-2 rounded-full border-4 border-white shadow-lg">
                <h2 id="victory-title" class="text-xl font-black text-white uppercase tracking-widest">Time's Up!</h2>
            </div>
            
            <div class="mt-8 flex flex-col items-center justify-center mb-6">
                <img src="Husky5.png" class="w-40 h-40 object-contain animate-bounce mb-4 drop-shadow-xl">
                
                <div class="relative">
                    <i data-lucide="star" class="text-yellow-400 w-32 h-32 fill-current animate-spin-slow"></i>
                    <div id="final-score" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-white font-black text-4xl drop-shadow-lg stroke-black">0</div>
                </div>
            </div>

            <p id="victory-msg" class="text-xl mb-8 font-bold text-slate-700">Great training session!</p>
            
            <button onclick="goToStartScreen()" class="w-full bg-green-500 hover:bg-green-400 text-white font-bold py-3 px-6 rounded-xl transition-all shadow-lg border-b-4 border-green-700 flex items-center justify-center gap-2 active:translate-y-1 active:shadow-none">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i> <span id="replay-btn-text">Battle Again</span>
            </button>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let currentLang = 'en';
        let score = 0;
        let level = 1;
        const EXP_NEEDED = 2; 
        const MAX_LEVEL = 5; 
        const GAME_DURATION = 60; 
        
        let playerHP = 100;
        let playerMaxHP = 100;
        let monsterHP = 0;
        let monsterMaxHP = 0;
        
        let currentProblem = {};
        let currentInput = ""; // Holds the typed answer string
        let isProcessing = false;
        let isGameActive = false;
        let isPaused = false;
        
        let globalTimerInterval;
        let globalTimeLeft = GAME_DURATION;
        let questionTimerInterval;
        let questionTimeLeft = 100;
        
        let idleInterval = null;
        let isIdleFrame1 = true;
        let idleSpeed = 500;

        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        let bgmInterval = null;
        let bgmNoteIndex = 0;

        // --- TRANSLATIONS (Shortened for mobile) ---
        const i18n = {
            en: {
                title: "Husky Calculation Battle",
                subtitle: "Help Husky defeat wild monsters!",
                instrTitle: "How to Play",
                instrList: [
                    "Type answer using keypad.",
                    "Game Time: <strong>60s</strong>. Max Level: <strong>5</strong>.",
                    "Correct answers deal damage.",
                    "Defeat a monster to <strong>Level Up</strong> & heal!",
                    "<strong>Warning:</strong> Monster attacks back!"
                ],
                startBtn: "Start Adventure",
                monsterName: "Monster",
                gameMsg: "Wild monster appeared!",
                monsterDefeated: "Defeated!",
                score: "Score",
                level: "Level",
                victoryTitle: "Time's Up!",
                victoryMsg: "Great Job!",
                replayBtn: "Play Again",
                correct: "Correct!",
                wrong: "Missed!",
                monsterAttack: "Attack!",
                langBtn: "中文",
                levelup: "Level Up!"
            },
            zh: {
                title: "哈士奇數算大戰",
                subtitle: "幫助哈士奇打敗野生怪物！",
                instrTitle: "遊戲說明",
                instrList: [
                    "使用鍵盤輸入答案。",
                    "遊戲時間：<strong>60秒</strong>。最高等級：<strong>5</strong>。",
                    "答對問題造成傷害。",
                    "打敗怪物可<strong>升級</strong>並回血！",
                    "<strong>注意：</strong> 怪物會反擊！"
                ],
                startBtn: "開始冒險",
                monsterName: "怪物",
                gameMsg: "怪物出現了！",
                monsterDefeated: "勝利！",
                score: "分數",
                level: "等級",
                victoryTitle: "時間到！",
                victoryMsg: "很棒的訓練！",
                replayBtn: "回到首頁",
                correct: "答對了！",
                wrong: "錯過了！",
                monsterAttack: "反擊！",
                langBtn: "English",
                levelup: "升級！"
            }
        };

        // --- KEYPAD FUNCTIONS ---
        function appendNumber(num) {
            if(isProcessing || !isGameActive || isPaused) return;
            if(currentInput.length >= 3) return; // Max 3 digits
            currentInput += num;
            updateAnswerDisplay();
        }

        function clearInput() {
            if(isProcessing || !isGameActive || isPaused) return;
            currentInput = "";
            updateAnswerDisplay();
        }

        function updateAnswerDisplay() {
            const display = document.getElementById('answer-display');
            display.innerText = currentInput === "" ? "?" : currentInput;
            
            // Visual feedback
            if(currentInput !== "") {
                display.classList.add('text-yellow-400');
            } else {
                display.classList.remove('text-yellow-400');
            }
        }

        // --- SOUND & BGM ---
        const BGM_NOTES = [261.63, 329.63, 392.00, 523.25]; 
        
        function startBGM() {
            stopBGM();
            bgmNoteIndex = 0;
            const tempo = Math.max(150, 500 - ((level - 1) * 80));
            bgmInterval = setInterval(() => {
                if(isPaused) return;
                const freq = BGM_NOTES[bgmNoteIndex % BGM_NOTES.length];
                playTone(freq, 'triangle', 0.1);
                if(bgmNoteIndex % 4 === 0) playTone(130.81, 'square', 0.2);
                bgmNoteIndex++;
            }, tempo);
        }
        
        function stopBGM() {
            if (bgmInterval) clearInterval(bgmInterval);
            bgmInterval = null;
        }

        function playTone(freq, type, duration) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playCorrectSound() { playTone(600, 'sine', 0.1); setTimeout(() => playTone(800, 'sine', 0.2), 100); }
        function playWrongSound() { playTone(150, 'sawtooth', 0.3); }
        function playLevelUpSound() {
            playTone(523.25, 'square', 0.1); setTimeout(() => playTone(659.25, 'square', 0.1), 100);
            setTimeout(() => playTone(783.99, 'square', 0.1), 200); setTimeout(() => playTone(1046.50, 'square', 0.4), 300);
        }
        function playGameOverSound() {
            playTone(300, 'triangle', 0.3); setTimeout(() => playTone(200, 'triangle', 0.3), 200);
            setTimeout(() => playTone(100, 'triangle', 0.6), 400);
        }
        function playHitSound() { playTone(100, 'sawtooth', 0.1); }

        // --- GAME LOGIC ---
        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en';
            updateLanguage();
        }

        function updateLanguage() {
            const t = i18n[currentLang];
            document.querySelectorAll('.lang-btn-text').forEach(el => el.innerText = t.langBtn);
            document.getElementById('title-text').innerText = t.title;
            document.getElementById('instr-title').innerHTML = `<i data-lucide="info" class="w-4 h-4"></i> ${t.instrTitle}`;
            const listEl = document.getElementById('instr-list');
            listEl.innerHTML = '';
            t.instrList.forEach(item => {
                const li = document.createElement('li');
                li.innerHTML = item;
                listEl.appendChild(li);
            });
            lucide.createIcons();

            document.getElementById('start-btn-text').innerText = t.startBtn;
            document.getElementById('enemy-name').innerText = t.monsterName;
            if(!isProcessing && isGameActive) document.getElementById('game-msg').innerText = t.gameMsg;
            document.getElementById('score-label').innerText = t.score;
            document.getElementById('level-label').innerText = t.level;
            document.getElementById('victory-msg').innerText = t.victoryMsg;
            document.getElementById('replay-btn-text').innerText = t.replayBtn;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            const timerContainer = document.getElementById('global-timer-container');
            if (screenId === 'game-screen') timerContainer.classList.remove('hidden');
            else timerContainer.classList.add('hidden');
        }

        function goToStartScreen() {
            stopIdleAnimation();
            stopBGM();
            showScreen('start-screen');
        }

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            score = 0;
            level = 1; 
            globalTimeLeft = GAME_DURATION;
            isGameActive = true;
            isPaused = false;
            currentInput = "";
            updateAnswerDisplay();
            
            playerMaxHP = 100;
            playerHP = playerMaxHP;
            monsterHP = 0; 

            updateHUD();
            updatePlayerHP();
            showScreen('game-screen');
            updateLanguage();
            startGlobalTimer();
            startIdleAnimation();
            startBGM();
            generateProblem();
        }

        function startIdleAnimation() {
            if (idleInterval) clearInterval(idleInterval);
            const playerSprite = document.getElementById('player-sprite');
            isIdleFrame1 = true;
            playerSprite.src = 'Husky1.png';
            idleSpeed = Math.max(150, 500 - ((level - 1) * 80));
            idleInterval = setInterval(() => {
                if(isPaused) return;
                isIdleFrame1 = !isIdleFrame1;
                playerSprite.src = isIdleFrame1 ? 'Husky1.png' : 'Husky2.png';
            }, idleSpeed);
        }

        function stopIdleAnimation() {
            if (idleInterval) { clearInterval(idleInterval); idleInterval = null; }
        }

        function spawnMonster() {
            const baseHP = 20 + (level * 10);
            monsterMaxHP = baseHP * (Math.floor(Math.random() * 1.5) + 1); 
            monsterHP = monsterMaxHP;
            
            let enemyId = Math.floor(Math.random() * 10) + 1; 
            const enemyImg = document.getElementById('enemy-sprite');
            enemyImg.src = `monster${enemyId}.png`;
            enemyImg.classList.remove('opacity-0', 'grayscale', 'scale-90', 'blur-sm');
            
            document.getElementById('game-msg').innerText = i18n[currentLang].gameMsg;
            document.getElementById('game-msg').className = "text-slate-300 font-medium text-sm md:text-lg";
            updateMonsterHUD();
        }

        function updateMonsterHUD() {
            document.getElementById('enemy-hp-text').innerText = `${Math.ceil(monsterHP)}/${Math.ceil(monsterMaxHP)}`;
            const hpPercent = (monsterHP / monsterMaxHP) * 100;
            const bar = document.getElementById('enemy-hp-bar');
            bar.style.width = `${hpPercent}%`;
            
            if(hpPercent < 30) {
                bar.className = 'h-full bg-red-500 w-full transition-all duration-500';
            } else if (hpPercent < 60) {
                bar.className = 'h-full bg-yellow-400 w-full transition-all duration-500';
            } else {
                bar.className = 'h-full bg-green-500 w-full transition-all duration-500';
            }
        }

        function updatePlayerHP() {
            const hpPercent = (playerHP / playerMaxHP) * 100;
            const bar = document.getElementById('player-hp-bar');
            bar.style.width = `${Math.max(0, hpPercent)}%`;
            document.getElementById('player-hp-text').innerText = `${Math.ceil(playerHP)}/${playerMaxHP}`;
            if(hpPercent < 30) bar.classList.replace('bg-green-500', 'bg-red-500');
            else bar.classList.replace('bg-red-500', 'bg-green-500');
        }

        function updateHUD() {
            document.getElementById('score-display').innerText = score;
            document.getElementById('level-text').innerText = level;
        }

        function startGlobalTimer() {
            clearInterval(globalTimerInterval);
            document.getElementById('global-time-display').innerText = globalTimeLeft;
            globalTimerInterval = setInterval(() => {
                if(isPaused) return;
                globalTimeLeft--;
                document.getElementById('global-time-display').innerText = globalTimeLeft;
                if (globalTimeLeft <= 10) {
                    document.getElementById('global-time-display').classList.add('text-red-500', 'animate-pulse');
                    playTone(800, 'sine', 0.05);
                }
                if (globalTimeLeft <= 0) endGame(true);
            }, 1000);
        }

        function generateProblem() {
            if (!isGameActive) return;
            isProcessing = false;
            
            if (monsterHP <= 0) spawnMonster();

            const num1 = Math.floor(Math.random() * 11);
            const num2 = Math.floor(Math.random() * (20 - num1 + 1));
            const ans = num1 + num2;
            currentProblem = { num1, num2, ans };

            document.getElementById('num1').innerText = num1;
            document.getElementById('num2').innerText = num2;
            currentInput = "";
            updateAnswerDisplay();
            
            startQuestionTimer();
        }

        function startQuestionTimer() {
            clearInterval(questionTimerInterval);
            questionTimeLeft = 100;
            const bar = document.getElementById('timer-bar');
            bar.style.width = '100%';
            bar.className = 'h-full bg-yellow-400 w-full timer-bar';
            
            const speedMs = Math.max(20, 100 - (level * 15)); 
            
            questionTimerInterval = setInterval(() => {
                if(isPaused) return;
                questionTimeLeft -= 1;
                bar.style.width = `${questionTimeLeft}%`;
                if(questionTimeLeft < 30) bar.classList.replace('bg-yellow-400', 'bg-red-500');
                if (questionTimeLeft <= 0) clearInterval(questionTimerInterval);
            }, speedMs);
        }

        function showLevelUpScene() {
            isPaused = true;
            const overlay = document.getElementById('levelup-overlay');
            overlay.classList.remove('hidden');
            playLevelUpSound();
            startIdleAnimation();
            startBGM();
            setTimeout(() => {
                overlay.classList.add('hidden');
                isPaused = false;
            }, 2000);
        }

        function submitAnswer() {
            if(isProcessing || !isGameActive || isPaused) return;
            
            const inputVal = parseInt(currentInput);
            if(isNaN(inputVal)) return;

            isProcessing = true;
            clearInterval(questionTimerInterval);

            const isCorrect = inputVal === currentProblem.ans;
            const t = i18n[currentLang];

            if(isCorrect) {
                playCorrectSound();
                document.getElementById('game-msg').innerHTML = `<span class="text-green-400 font-bold animate-pulse">${t.correct}</span>`;
                
                const playerContainer = document.getElementById('player-container');
                const attackEffect = document.getElementById('attack-effect');
                const enemySprite = document.getElementById('enemy-sprite');
                
                stopIdleAnimation();
                document.getElementById('player-sprite').src = 'Husky3.png';
                
                playerContainer.classList.add('translate-x-8', '-translate-y-4');
                attackEffect.classList.remove('hidden');

                const levelBase = 10 + (level * 5); 
                const timeBonus = Math.max(0, Math.floor(questionTimeLeft / 5)); 
                const damage = levelBase + timeBonus;
                
                score += damage;
                monsterHP -= damage;
                if (monsterHP < 0) monsterHP = 0;
                updateMonsterHUD();
                updateHUD();

                if (monsterHP <= 0) {
                    if (level < MAX_LEVEL) {
                        level++;
                        showLevelUpScene();
                    }
                    updateHUD();

                    setTimeout(() => {
                        enemySprite.classList.add('opacity-0', 'grayscale', 'scale-90', 'blur-sm');
                        document.getElementById('game-msg').innerHTML = `<span class="text-yellow-400 font-bold">${t.monsterDefeated}</span>`;
                        
                        const regen = Math.floor(playerMaxHP * 0.3);
                        playerHP = Math.min(playerMaxHP, playerHP + regen);
                        updatePlayerHP();
                        
                        setTimeout(() => {
                            cleanupAttackAnim();
                            generateProblem();
                        }, 1500);
                    }, 300);
                } else {
                     setTimeout(() => {
                        enemySprite.classList.add('animate-damage');
                     }, 100);
                     setTimeout(() => {
                        enemySprite.classList.remove('animate-damage');
                     }, 500);
                     
                     setTimeout(() => {
                        cleanupAttackAnim();
                        triggerMonsterAttack();
                     }, 1000);
                }

            } else {
                playWrongSound();
                document.getElementById('game-msg').innerHTML = `<span class="text-red-400 font-bold">${t.wrong}</span>`;
                setTimeout(() => {
                    triggerMonsterAttack();
                }, 1000);
            }
        }
        
        function cleanupAttackAnim() {
            const playerContainer = document.getElementById('player-container');
            const attackEffect = document.getElementById('attack-effect');
            playerContainer.classList.remove('translate-x-8', '-translate-y-4');
            attackEffect.classList.add('hidden');
            startIdleAnimation();
        }

        function triggerMonsterAttack() {
            if(!isGameActive || monsterHP <= 0) {
                if(isGameActive) generateProblem();
                return;
            }

            const t = i18n[currentLang];
            document.getElementById('game-msg').innerHTML = `<span class="text-red-500 font-bold">${t.monsterAttack}</span>`;
            
            const enemyContainer = document.getElementById('enemy-container');
            const monsterAttackEffect = document.getElementById('monster-attack-effect');
            const playerSprite = document.getElementById('player-sprite');
            
            enemyContainer.classList.add('-translate-x-8', 'translate-y-4');
            monsterAttackEffect.classList.remove('hidden');
            
            setTimeout(() => {
                playHitSound();
                playerSprite.classList.add('animate-hit');
                
                const monsterDamage = 15 + (level * 5);
                playerHP -= monsterDamage;
                updatePlayerHP();
                
                setTimeout(() => {
                    enemyContainer.classList.remove('-translate-x-8', 'translate-y-4');
                    monsterAttackEffect.classList.add('hidden');
                    playerSprite.classList.remove('animate-hit');
                    
                    if (playerHP <= 0) {
                        endGame(false); 
                    } else {
                        generateProblem();
                    }
                }, 500);
            }, 300);
        }

        function endGame(isTimeUp = false) {
            playGameOverSound();
            stopBGM();
            isGameActive = false;
            stopIdleAnimation();
            clearInterval(globalTimerInterval);
            clearInterval(questionTimerInterval);
            
            const t = i18n[currentLang];
            document.getElementById('victory-title').innerText = t.victoryTitle;
            document.getElementById('victory-msg').innerText = t.victoryMsg;
            document.getElementById('final-score').innerText = score;
            
            showScreen('summary-screen');
        }

        // Keep physical keyboard support
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('game-screen').classList.contains('active')) {
                if (e.key >= '0' && e.key <= '9') {
                    appendNumber(parseInt(e.key));
                } else if (e.key === 'Backspace') {
                    if(currentInput.length > 0) {
                        currentInput = currentInput.slice(0, -1);
                        updateAnswerDisplay();
                    }
                } else if (e.key === 'Enter') {
                    submitAnswer();
                } else if (e.key === 'Escape') {
                    clearInput();
                }
            }
        });
        
        updateLanguage();
        lucide.createIcons();

    </script>
</body>
</html>
