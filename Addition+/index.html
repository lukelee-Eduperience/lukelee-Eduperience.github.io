<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>數字小射手：加法大冒險</title>
  <style>
    :root{
      --bg:#E9F8FF;
      --panel:#FFFFFF;
      --accent:#FF7A7A;
      --accent2:#6ED3A7;
      --text:#1F2D3D;
      --score-bg:#FFF6C8;
      --round-bg:#DFF7E3;
      --balloon:#FFD9F0;
    }
    html,body{
      height:100%;
      margin:0;
      font-family: "Noto Sans TC", "Helvetica Neue", Arial, sans-serif;
      -webkit-user-select:none;
      user-select:none;
      background: linear-gradient(180deg, var(--bg) 0%, #F7FFFF 100%);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    .container{
      max-width:1024px;
      margin:0 auto;
      padding:12px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      height:100vh;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px;
    }
    .title{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo {
      width:64px;
      height:64px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--accent),#FFB27A);
      display:flex;
      align-items:center;
      justify-content:center;
      color:white;
      font-weight:800;
      font-size:18px;
      box-shadow:0 6px 14px rgba(0,0,0,0.08);
    }
    .h1{
      font-size:20px;
      line-height:1;
    }
    .subtitle{
      font-size:12px;
      color:#2F4B5A;
      opacity:0.9;
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .panel{
      background:var(--panel);
      border-radius:12px;
      padding:8px 12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.06);
    }
    .score{
      min-width:84px;
      text-align:center;
      background:var(--score-bg);
      border-radius:10px;
      padding:6px 10px;
      font-weight:700;
      font-size:16px;
    }
    .round{
      min-width:120px;
      text-align:center;
      background:var(--round-bg);
      border-radius:10px;
      padding:6px 10px;
      font-weight:700;
      font-size:14px;
    }
    .timer{
      min-width:110px;
      text-align:center;
      background:linear-gradient(90deg,#FFF2F2,#FFEFE8);
      border-radius:10px;
      padding:6px 10px;
      font-weight:800;
      color:var(--accent);
      font-size:16px;
    }

    main{
      flex:1;
      display:flex;
      gap:12px;
      align-items:stretch;
      margin-top:8px;
    }

    /* left: game area */
    .game-area{
      flex:2;
      position:relative;
      border-radius:16px;
      overflow:hidden;
      background:
         radial-gradient(circle at 10% 10%, rgba(255,255,255,0.6), transparent 30%),
         linear-gradient(180deg, #FFF 0%, #F2FFFF 100%);
      padding:12px;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .playfield{
      position:relative;
      flex:1;
      width:100%;
      background:linear-gradient(180deg,#E8F9FF 0%, #DFF6FF 100%);
      border-radius:12px;
      border:4px dashed rgba(255,255,255,0.6);
      overflow:hidden;
      touch-action: manipulation;
    }

    /* shooter area bottom */
    .shooter-row{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      padding:8px 0;
    }
    .shooter{
      width:140px;
      height:56px;
      border-radius:28px;
      background:linear-gradient(180deg,#FFEEDE,#FFD9C4);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:var(--text);
      box-shadow:0 6px 12px rgba(0,0,0,0.06);
      user-select:none;
    }
    .answer-bubble{
      background:var(--balloon);
      padding:8px 12px;
      border-radius:18px;
      font-weight:800;
      font-size:18px;
      min-width:36px;
      text-align:center;
      color:#8A2A5B;
    }

    /* right: control area */
    .side{
      width:340px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .control{
      border-radius:16px;
      padding:12px;
    }
    .problem-box{
      background:linear-gradient(180deg,#FFF,#FFF7F0);
      border-radius:12px;
      padding:12px;
      text-align:center;
      box-shadow:0 6px 14px rgba(0,0,0,0.06);
    }
    .problem-text{
      font-size:22px;
      font-weight:900;
      color:var(--accent2);
    }
    .hint{
      font-size:12px;
      color:#516271;
      margin-top:6px;
    }

    .controls-grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
      margin-top:8px;
    }
    .num-btn{
      background:linear-gradient(180deg,#FFFFFF,#FFF3F3);
      border-radius:12px;
      padding:14px 6px;
      font-size:18px;
      font-weight:800;
      text-align:center;
      cursor:pointer;
      user-select:none;
      box-shadow:0 6px 10px rgba(0,0,0,0.06);
    }
    .num-btn:active{ transform:translateY(2px); }
    .action-row{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    .wide-btn{
      flex:1;
      padding:10px;
      background:linear-gradient(90deg,var(--accent2),#64C9A0);
      color:white;
      border-radius:12px;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      text-align:center;
    }

    /* floating targets inside playfield */
    .target{
      position:absolute;
      min-width:60px;
      min-height:46px;
      padding:6px 10px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:18px;
      color:white;
      box-shadow:0 8px 18px rgba(0,0,0,0.12);
      touch-action:none;
      user-select:none;
    }
    .target.easy{ background:linear-gradient(135deg,#FFB27A,#FF7A7A); }
    .target.medium{ background:linear-gradient(135deg,#FFD86E,#FFB27A); }
    .target.hard{ background:linear-gradient(135deg,#8CD9A8,#2FB084); }

    /* feedback */
    .feedback{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:18px;
      background:rgba(255,255,255,0.95);
      padding:8px 14px;
      border-radius:20px;
      font-weight:900;
      box-shadow:0 8px 20px rgba(0,0,0,0.08);
      display:flex;
      gap:10px;
      align-items:center;
      pointer-events:none;
      opacity:0;
      transition:opacity .18s ease,transform .18s ease;
    }
    .feedback.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    .big-center{
      position:absolute;
      left:50%;
      top:40%;
      transform:translate(-50%,-50%);
      background:rgba(255,255,255,0.9);
      border-radius:16px;
      padding:14px 18px;
      text-align:center;
      display:none;
      box-shadow:0 16px 40px rgba(0,0,0,0.12);
    }
    .big-center.show{ display:block; }

    /* small / mobile friendly */
    @media (max-width:900px){
      .container{ padding:8px; }
      .side{ width:46%; }
      .score{ font-size:14px; }
      .timer{ font-size:14px; }
      .title .h1{ font-size:16px; }
    }
    @media (max-width:640px){
      main{ flex-direction:column; }
      .side{ width:100%; order:2; }
      .game-area{ order:1; }
      .logo{ width:54px; height:54px; font-size:16px; }
      .shooter{ width:120px; height:48px; border-radius:24px; font-size:14px; }
    }
  </style>
</head>
<body>
  <div class="container" aria-label="數學加法射擊遊戲介面">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true">小數字</div>
        <div>
          <div class="h1">數字小射手：加法大冒險</div>
          <div class="subtitle">每答對一題得10分 — 60秒一回合</div>
        </div>
      </div>

      <div class="topbar">
        <div class="panel score" id="scorePanel" aria-live="polite">分數: 0</div>
        <div class="panel round" id="roundPanel">回合: 1</div>
        <div class="panel timer" id="timerPanel">時間: 60s</div>
      </div>
    </header>

    <main>
      <section class="game-area panel" aria-label="遊戲畫面">
        <div class="playfield" id="playfield" role="application" aria-label="射擊區域">
          <!-- targets appended here -->
          <div class="feedback" id="feedback" aria-live="assertive"></div>
          <div class="big-center" id="centerMsg">
            <div id="centerTitle" style="font-size:20px;font-weight:900;color:#333;">準備好了嗎？</div>
            <div id="centerSub" style="margin-top:8px;color:#556B74;font-size:14px;">點擊開始即可</div>
            <div style="margin-top:12px;">
              <button class="wide-btn" id="startBtn">開始遊戲</button>
            </div>
          </div>
        </div>

        <div class="shooter-row" aria-hidden="false">
          <div class="shooter">發射器</div>
          <div class="answer-bubble" id="currentAnswer" aria-live="polite">0</div>
          <div class="shooter" style="background:linear-gradient(180deg,#E8F8F0,#CFF3E6);">拖曳或按鈕出手</div>
        </div>
      </section>

      <aside class="side">
        <div class="control panel problem-box" aria-label="題目區">
          <div style="font-size:12px;color:#3A5562;font-weight:800">目標：在 60 秒內最快答題，答對 +10 分</div>
          <div class="problem-text" id="problemText" aria-live="polite" style="margin-top:8px;">0 + 0 = ?</div>
          <div class="hint">提示：拖曳你想發射的數字泡泡到表情目標上；或在右方按號碼再按「發射」</div>
        </div>

        <div class="control panel">
          <div style="font-weight:900;margin-bottom:6px">數字面板</div>
          <div class="controls-grid" id="numGrid" role="group" aria-label="數字按鈕">
            <!-- buttons 0-9 -->
          </div>
          <div class="action-row">
            <div class="wide-btn" id="shootBtn">發射</div>
            <div class="wide-btn" id="clearBtn" style="background:linear-gradient(90deg,#FFEFA8,#FFD86E); color:#5A3F00;">清除</div>
          </div>
          <div style="margin-top:10px;font-size:13px;color:#3F5D6A">
            回合要求：達到 80 分 可挑戰下一回合。難度隨回合升高。
          </div>
        </div>

        <div class="control panel" style="display:flex;flex-direction:column;gap:8px;align-items:stretch;">
          <div style="font-weight:900">操作說明（適用 iPad 觸控 / 滑鼠）</div>
          <div style="font-size:13px;color:#3F5D6A">- 在畫面中拖曳數字泡泡到漂浮的目標上即為射擊。或在數字面板選擇數字，按「發射」。</div>
          <div style="font-size:13px;color:#3F5D6A">- 每答對一題 +10 分。時間 60 秒。</div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    // Game config
    const ROUND_TIME = 60; // seconds
    const POINTS_PER_CORRECT = 10;
    const SCORE_TO_ADVANCE = 80;

    // State
    let score = 0;
    let round = 1;
    let timeLeft = ROUND_TIME;
    let timerInterval = null;
    let currentProblem = {a:0,b:0,answer:0};
    let selectedValue = null;
    let playing = false;
    let targets = [];
    const playfield = document.getElementById('playfield');
    const scorePanel = document.getElementById('scorePanel');
    const roundPanel = document.getElementById('roundPanel');
    const timerPanel = document.getElementById('timerPanel');
    const problemText = document.getElementById('problemText');
    const currentAnswer = document.getElementById('currentAnswer');
    const feedback = document.getElementById('feedback');
    const centerMsg = document.getElementById('centerMsg');
    const startBtn = document.getElementById('startBtn');
    const shootBtn = document.getElementById('shootBtn');
    const clearBtn = document.getElementById('clearBtn');
    const numGrid = document.getElementById('numGrid');

    // create number buttons 0-9
    for(let i=1;i<=9;i++){
      const btn = document.createElement('div');
      btn.className='num-btn';
      btn.textContent = String(i);
      btn.tabIndex = 0;
      btn.addEventListener('click', ()=>selectNumber(i));
      btn.addEventListener('touchstart', ()=>selectNumber(i));
      numGrid.appendChild(btn);
    }
    // zero button last
    const btn0 = document.createElement('div');
    btn0.className='num-btn';
    btn0.textContent='0';
    btn0.tabIndex=0;
    btn0.addEventListener('click', ()=>selectNumber(0));
    btn0.addEventListener('touchstart', ()=>selectNumber(0));
    numGrid.appendChild(btn0);

    function selectNumber(n){
      selectedValue = n;
      currentAnswer.textContent = String(n);
      flashFeedbackTemp('選擇: ' + n, 700, '#333', false);
    }

    clearBtn.addEventListener('click', ()=> {
      selectedValue = null;
      currentAnswer.textContent = '0';
    });

    shootBtn.addEventListener('click', ()=> {
      if(!playing) return;
      if(selectedValue === null) { flashFeedbackTemp('請先選擇數字',900,'#B23A3A'); return; }
      // simulate shooting: find nearest target to center bottom
      const t = findClosestTargetToBottomCenter();
      if(t) attemptHit(t, selectedValue);
    });

    startBtn.addEventListener('click', startRound);

    function startRound(){
      // reset state
      score = 0;
      timeLeft = ROUND_TIME;
      round = Math.max(1, round); // preserve if progressing later
      updateUI();
      playing = true;
      centerMsg.classList.remove('show');
      clearTargets();
      spawnTargetsForRound(round);
      startTimer();
    }

    function startTimer(){
      updateTimerPanel();
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        timeLeft--;
        updateTimerPanel();
        if(timeLeft <= 0){
          clearInterval(timerInterval);
          endRound();
        }
      },1000);
    }

    function endRound(){
      playing = false;
      clearTargets();
      centerMsg.classList.add('show');
      const passed = score >= SCORE_TO_ADVANCE;
      document.getElementById('centerTitle').textContent = passed ? '恭喜過關！' : '時間到！';
      document.getElementById('centerSub').textContent = passed ? 
        `您得了 ${score} 分，可挑戰下一回合` :
        `您得了 ${score} 分，需 ${SCORE_TO_ADVANCE} 分才能進入下一回合`;
      startBtn.textContent = passed ? '下一回合' : '再試一次';
      startBtn.onclick = ()=> {
        if(passed){
          round++;
        } else {
          round = 1;
        }
        startRound();
      };
    }

    function updateUI(){
      scorePanel.textContent = `分數: ${score}`;
      roundPanel.textContent = `回合: ${round}`;
      problemText.textContent = `${currentProblem.a} + ${currentProblem.b} = ?`;
      currentAnswer.textContent = selectedValue === null ? '0' : String(selectedValue);
    }
    function updateTimerPanel(){
      timerPanel.textContent = `時間: ${timeLeft}s`;
    }

    function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function spawnTargetsForRound(r){
      // difficulty scales: generate more targets and larger sums
      const count = Math.min(10, 4 + r); // number of floating targets
      const maxAddend = Math.min(20, 5 + r*3); // bigger with rounds
      for(let i=0;i<count;i++){
        const a = randomInt(0, maxAddend);
        const b = randomInt(0, maxAddend);
        createTarget(a,b,i);
      }
      // also set current problem as one of them
      chooseNewProblemFromTargets();
    }

    function clearTargets(){
      targets.forEach(t => {
        if(t.el && t.el.parentNode) t.el.parentNode.removeChild(t.el);
        if(t.interval) clearInterval(t.interval);
      });
      targets = [];
    }

    function createTarget(a,b,idx){
      const el = document.createElement('div');
      const sum = a + b;
      el.className = 'target';
      // difficulty class
      const difficultyClass = sum <= 7 ? 'easy' : (sum <= 15 ? 'medium' : 'hard');
      el.classList.add(difficultyClass);
      el.textContent = `${a} + ${b}`;
      playfield.appendChild(el);

      // random position inside playfield
      const rect = playfield.getBoundingClientRect();
      const w = Math.max(60, Math.min(120, rect.width * 0.22));
      el.style.minWidth = w + 'px';
      const x = randomInt(10, Math.max(10, rect.width - w - 10));
      const y = randomInt(10, Math.max(10, rect.height - 140));
      el.style.left = x + 'px';
      el.style.top = y + 'px';

      // floating motion
      let dx = (Math.random()-0.5)*0.6;
      let dy = (Math.random()-0.5)*0.6;
      const interval = setInterval(()=>{
        let nx = el.offsetLeft + dx*6;
        let ny = el.offsetTop + dy*6;
        if(nx < 6 || nx > rect.width - el.offsetWidth - 6) dx = -dx;
        if(ny < 6 || ny > rect.height - el.offsetHeight - 6) dy = -dy;
        el.style.left = Math.max(6, Math.min(rect.width - el.offsetWidth - 6, nx)) + 'px';
        el.style.top = Math.max(6, Math.min(rect.height - el.offsetHeight - 6, ny)) + 'px';
      },80);

      // drag support
      let dragging = false;
      let startX=0,startY=0,origX=0,origY=0;
      function pointerDown(e){
        e.preventDefault();
        dragging = true;
        startX = (e.touches ? e.touches[0].clientX : e.clientX);
        startY = (e.touches ? e.touches[0].clientY : e.clientY);
        origX = el.offsetLeft;
        origY = el.offsetTop;
        el.style.transition = 'none';
      }
      function pointerMove(e){
        if(!dragging) return;
        const px = (e.touches ? e.touches[0].clientX : e.clientX);
        const py = (e.touches ? e.touches[0].clientY : e.clientY);
        const dxp = px - startX;
        const dyp = py - startY;
        el.style.left = (origX + dxp - playfield.getBoundingClientRect().left) + 'px';
        el.style.top = (origY + dyp - playfield.getBoundingClientRect().top) + 'px';
      }
      function pointerUp(e){
        if(!dragging) return;
        dragging = false;
        el.style.transition = '';
        // check if dropped near bottom center (shooter area)
        const pfRect = playfield.getBoundingClientRect();
        const centerX = pfRect.width/2;
        const bottomY = pfRect.height - 10;
        const elCx = el.offsetLeft + el.offsetWidth/2;
        const elCy = el.offsetTop + el.offsetHeight/2;
        const dist = Math.hypot(elCx - centerX, elCy - bottomY);
        if(dist < Math.max(80, pfRect.width*0.18)){
          // this counts as a shot using the target's value (simulate auto-fire)
          // In our design, dragging the target itself is treated as shooting that target with its correct answer.
          attemptHitByTarget(idx);
        } else {
          // snap back after slight delay
          setTimeout(()=>{},120);
        }
      }

      el.addEventListener('touchstart', pointerDown, {passive:false});
      window.addEventListener('touchmove', pointerMove, {passive:false});
      window.addEventListener('touchend', pointerUp);
      el.addEventListener('mousedown', pointerDown);
      window.addEventListener('mousemove', pointerMove);
      window.addEventListener('mouseup', pointerUp);

      targets.push({a,b,sum,el,interval,idx});
    }

    function chooseNewProblemFromTargets(){
      if(targets.length === 0) return;
      const pick = targets[randomInt(0, targets.length-1)];
      currentProblem = {a: pick.a, b: pick.b, answer: pick.sum};
      updateUI();
    }

    function findClosestTargetToBottomCenter(){
      if(targets.length === 0) return null;
      const pf = playfield.getBoundingClientRect();
      const cx = pf.width/2;
      const by = pf.height;
      let best = null;
      let bestD = 1e9;
      targets.forEach(t=>{
        const el = t.el;
        const ex = el.offsetLeft + el.offsetWidth/2;
        const ey = el.offsetTop + el.offsetHeight/2;
        const d = Math.hypot(ex - cx, ey - by);
        if(d < bestD){ bestD = d; best = t; }
      });
      return best;
    }

    function attemptHit(targetObj, chosen){
      if(!playing) return;
      const isCorrect = chosen === targetObj.sum;
      processHitResult(isCorrect, targetObj);
    }

    function attemptHitByTarget(idx){
      if(!playing) return;
      // dragging a target to shooter counts as answering that target's sum:
      const t = targets.find(x=>x.idx===idx);
      if(!t) return;
      const chosen = t.sum; // assume child selects correct sum when dragging that target
      // check against current problem (the displayed problem)
      const isCorrect = (chosen === currentProblem.answer);
      processHitResult(isCorrect, t);
    }

    function processHitResult(isCorrect, targetObj){
      // remove target visual
      if(targetObj && targetObj.el && targetObj.el.parentNode){
        targetObj.el.parentNode.removeChild(targetObj.el);
      }
      // stop its motion interval
      if(targetObj.interval) clearInterval(targetObj.interval);
      // remove from targets array
      targets = targets.filter(t=>t !== targetObj);

      if(isCorrect){
        score += POINTS_PER_CORRECT;
        flashFeedback('Good!', '#2B8F52', true);
      } else {
        flashFeedback('✕', '#D23A3A', false);
      }

      // pick a new problem from existing targets if any, else spawn new
      if(targets.length > 0){
        chooseNewProblemFromTargets();
      } else {
        // spawn a few more
        spawnTargetsForRound(round);
        chooseNewProblemFromTargets();
      }
      updateUI();
    }

    function flashFeedback(text, color, positive){
      feedback.textContent = text;
      feedback.style.color = color;
      feedback.classList.add('show');
      setTimeout(()=> feedback.classList.remove('show'), 700);
    }
    function flashFeedbackTemp(text, ms=700, color='#333', positive=true){
      feedback.textContent = text;
      feedback.style.color = color;
      feedback.classList.add('show');
      setTimeout(()=> feedback.classList.remove('show'), ms);
    }

    // initial UI
    updateUI();
    updateTimerPanel();
    centerMsg.classList.add('show');

    // Accessibility: allow keyboard number input for desktop
    window.addEventListener('keydown', (e)=>{
      if(e.key >= '0' && e.key <= '9'){ selectNumber(Number(e.key)); }
      if(e.key === 'Enter'){ shootBtn.click(); }
      if(e.key === 'Backspace' || e.key === 'Delete'){ clearBtn.click(); }
    });

    // Prevent scrolling on touch drag inside playfield for better iPad experience
    playfield.addEventListener('touchmove', (e)=>{ e.preventDefault(); }, {passive:false});
  </script>
</body>
</html>
